# TTRC-231 Todo List

**Status:** Not Started
**JIRA:** [TTRC-231](https://ajwolfe37.atlassian.net/browse/TTRC-231)
**Plan:** See `2025-10-13-ttrc231-plan.md`

---

## Session Start Checklist
- [ ] Read handoff: `docs/handoffs/2025-10-13-ttrc231-plan.md`
- [ ] Read startup prompt: `docs/STARTUP_PROMPT.md`
- [ ] Check JIRA TTRC-231 status
- [ ] Confirm on TEST branch (`git branch --show-current`)
- [ ] Create TodoWrite tracking list

---

## Task 1: Lifecycle Management Automation

### Implementation
- [ ] Create `scripts/rss/lifecycle.js`
  - [ ] Export `updateLifecycleStates()` function
  - [ ] Call SQL RPC `update_story_lifecycle_states()`
  - [ ] Log state transitions and counts
  - [ ] Handle errors gracefully
- [ ] Create `migrations/025_lifecycle_automation.sql`
  - [ ] Create SQL function `update_story_lifecycle_states()`
  - [ ] Test function manually in SQL editor
  - [ ] Verify correct state transitions
- [ ] Create `scripts/enqueue-lifecycle-job.js`
  - [ ] Helper script for cron to enqueue job
  - [ ] Insert `story.lifecycle` job into queue
- [ ] Modify `scripts/job-queue-worker.js`
  - [ ] Add `story.lifecycle` handler
  - [ ] Map to lifecycle.js function
- [ ] Create `.github/workflows/lifecycle-update.yml`
  - [ ] Hourly cron schedule
  - [ ] Call enqueue helper script
  - [ ] Test workflow manually

### Testing
- [ ] Create test stories with backdated `last_updated_at`
  - [ ] Story from 3 hours ago (should be emerging)
  - [ ] Story from 24 hours ago (should be growing)
  - [ ] Story from 72 hours ago (should be stable)
  - [ ] Story from 7 days ago (should be stale)
- [ ] Run lifecycle job manually
- [ ] Verify all states transition correctly
- [ ] Check logs for state counts

### Acceptance
- [ ] SQL function updates states correctly
- [ ] Job handler runs without errors
- [ ] Cron triggers (verify in GitHub Actions)
- [ ] State transitions logged

---

## Task 2: Auto-Split Detection

### Implementation
- [ ] Create `scripts/rss/auto-split.js`
  - [ ] Implement `calculateInternalCoherence(story_id)`
    - [ ] Fetch all articles with embeddings
    - [ ] Calculate pairwise cosine similarity
    - [ ] Sample if >20 articles
    - [ ] Return median score
  - [ ] Implement `checkForSplit(story_id)`
    - [ ] Get coherence score
    - [ ] If <0.50, trigger split
    - [ ] Re-cluster articles using hybrid scoring
    - [ ] Create new stories as needed
    - [ ] Return split results
  - [ ] Implement `splitStory(story_id, clusters)`
    - [ ] Create new stories for each cluster
    - [ ] Move article_story records
    - [ ] Update centroids
    - [ ] Mark original story as split
- [ ] Add job handler to `scripts/job-queue-worker.js`
  - [ ] Add `story.split` handler
  - [ ] Map to auto-split.js function

### Testing
- [ ] Create test story with 2 unrelated articles
  - [ ] Article 1: Trump article
  - [ ] Article 2: Completely different topic
- [ ] Run split detection
- [ ] Verify 2 separate stories created
- [ ] Check articles reassigned correctly
- [ ] Verify centroids updated

### Edge Cases
- [ ] Test with story <2 articles (should skip)
- [ ] Test with all coherent articles (should not split)
- [ ] Test with missing embeddings (should handle gracefully)

### Acceptance
- [ ] Coherence calculation returns 0.0-1.0
- [ ] Split detection identifies diverging stories
- [ ] Articles reassigned correctly
- [ ] No data loss during split

---

## Task 3: Periodic Merge Detection

### Implementation
- [ ] Create `migrations/026_merge_audit_trail.sql`
  - [ ] Create `story_merge_actions` table
  - [ ] Add indexes (source_id, target_id, merged_at)
  - [ ] Add `merged_into` to story_status enum if needed
  - [ ] Test migration in SQL editor
- [ ] Create `scripts/rss/periodic-merge.js`
  - [ ] Implement `findMergeCandidates()`
    - [ ] Find pairs with coherence >0.70
    - [ ] Filter: 3+ shared entities
    - [ ] Filter: within 5-day window
    - [ ] Filter: same primary actor
    - [ ] Return ranked candidates (top 10)
  - [ ] Implement `mergeStories(sourceId, targetId)`
    - [ ] Move article_story records to target
    - [ ] Update target story metadata
    - [ ] Recompute target centroid
    - [ ] Mark source as merged_into
    - [ ] Insert audit record
    - [ ] Return merge results
  - [ ] Export `runMergeDetection()` for job handler
- [ ] Create `scripts/enqueue-merge-job.js`
  - [ ] Helper script for cron
  - [ ] Insert `story.merge` job into queue
- [ ] Add job handler to `scripts/job-queue-worker.js`
  - [ ] Add `story.merge` handler
  - [ ] Map to periodic-merge.js function
- [ ] Create `.github/workflows/story-merge.yml`
  - [ ] Daily cron at 2am UTC
  - [ ] Call enqueue helper script
  - [ ] Test workflow manually

### Testing
- [ ] Create 2 duplicate stories manually
  - [ ] Same headline variants
  - [ ] Share 3+ entities
  - [ ] Within 5 days of each other
  - [ ] Same primary actor
- [ ] Run merge detection
- [ ] Verify stories merged
- [ ] Check audit trail
- [ ] Verify no data loss

### Safety Checks
- [ ] Never merge stories with different actors
- [ ] Require >3 shared entities
- [ ] Log all merge operations
- [ ] Test rollback if needed

### Acceptance
- [ ] Merge candidates identified correctly
- [ ] Stories merge without data loss
- [ ] Audit trail complete
- [ ] Daily cron runs successfully

---

## Task 4: Real Clustering Accuracy Test

### Setup
- [ ] Review existing `scripts/test-real-clustering.js`
- [ ] Decide ingestion method:
  - [ ] Option A: Manual enqueue with full metadata
  - [ ] Option B: Add to test RSS feed
  - [ ] Option C: Use articles-manual API endpoint
- [ ] Prepare 4 test articles (URLs in plan doc)

### Implementation
- [ ] Modify `scripts/test-real-clustering.js`
  - [ ] Remove manual article insertion
  - [ ] Add proper RSS ingestion
  - [ ] Generate embeddings via OpenAI
  - [ ] Extract entities
  - [ ] Run clustering
- [ ] Run test and capture results
  - [ ] Record score breakdown
  - [ ] Record performance metrics (p50, p95, p99)
  - [ ] Record final story details

### Validation
- [ ] All 4 articles cluster to SAME story
- [ ] Scores all ≥0.60 threshold
- [ ] Performance <500ms p95
- [ ] Final story has 4 sources

### Documentation
- [ ] Update JIRA with test results
  - [ ] Precision: X%
  - [ ] Recall: X%
  - [ ] Performance: p95=Xms
  - [ ] Screenshot of results
- [ ] Document any tuning needed

### Acceptance
- [ ] 4 articles cluster correctly
- [ ] >85% accuracy demonstrated
- [ ] <500ms p95 latency
- [ ] Results in JIRA

---

## Task 5: Integration Testing

### Test Files to Create
- [ ] `tests/clustering-integration.test.js`
  - [ ] End-to-end clustering tests
  - [ ] Performance benchmarks
- [ ] `tests/lifecycle.test.js`
  - [ ] State transition tests
  - [ ] Cron job tests
- [ ] `tests/split-merge.test.js`
  - [ ] Split detection tests
  - [ ] Merge detection tests

### Test Implementation
- [ ] Lifecycle tests
  - [ ] Test emerging → growing (6h)
  - [ ] Test growing → stable (48h)
  - [ ] Test stable → stale (5d)
  - [ ] Test SQL function directly
- [ ] Split tests
  - [ ] Test coherent story (no split)
  - [ ] Test diverging story (splits)
  - [ ] Test edge cases
- [ ] Merge tests
  - [ ] Test duplicate detection
  - [ ] Test merge execution
  - [ ] Test audit trail
- [ ] End-to-end tests
  - [ ] Test full clustering pipeline
  - [ ] Test centroid updates
  - [ ] Test performance

### CI/CD Integration
- [ ] Add test scripts to `package.json`
  - [ ] `npm run test:clustering`
  - [ ] `npm run test:lifecycle`
  - [ ] `npm run test:split-merge`
- [ ] Add to GitHub Actions workflow
  - [ ] Run on PR to test branch
  - [ ] Block merge if tests fail

### Acceptance
- [ ] All tests pass locally
- [ ] Tests run in CI/CD
- [ ] No regressions
- [ ] Coverage >80%

---

## Task 6: Database Migrations

### Migration 025
- [ ] Create `migrations/025_lifecycle_automation.sql`
- [ ] Test in SQL editor
- [ ] Apply to TEST database: `node scripts/apply-migrations.js`
- [ ] Verify function exists
- [ ] Run function manually to test

### Migration 026
- [ ] Create `migrations/026_merge_audit_trail.sql`
- [ ] Test in SQL editor
- [ ] Apply to TEST database
- [ ] Verify table and indexes exist
- [ ] Insert test audit record

### Verification
- [ ] Check migration history
- [ ] Verify all columns/functions exist
- [ ] Test rollback if needed

---

## Task 7: QA & Validation

### Manual Testing
- [ ] Run all test scripts
  - [ ] `node scripts/test-real-clustering.js`
  - [ ] `node scripts/test-stale-reopening.js` (regression)
  - [ ] Any other existing tests
- [ ] Test lifecycle cron manually
- [ ] Test merge cron manually
- [ ] Check logs for errors

### Validation Agent
- [ ] Use Task tool with general-purpose agent
- [ ] Validate all new code files
- [ ] Check for edge cases
- [ ] Verify no regressions

### Code Quality
- [ ] Check for console.errors
- [ ] Verify error handling
- [ ] Check performance (no N+1 queries)
- [ ] Verify SQL injection prevention

---

## Task 8: Git & AI Review

### Commit Files
- [ ] Stage all new files
- [ ] Stage all modified files
- [ ] Create descriptive commit message
- [ ] Commit with co-author line
- [ ] Push to TEST branch

### AI Code Review
- [ ] Push triggers workflow automatically
- [ ] Wait for workflow to complete
- [ ] Check for blockers
- [ ] Fix any issues found
- [ ] Re-push if needed

### Final Checks
- [ ] All workflows passing
- [ ] No blockers
- [ ] Performance acceptable
- [ ] Ready for prod

---

## Task 9: Documentation & Handoff

### JIRA Update
- [ ] Update TTRC-231 description with results
- [ ] Mark all acceptance criteria as done
- [ ] Add comment with test results
- [ ] Update status to "Ready for Prod"
- [ ] Link to PR or commits

### Handoff Document
- [ ] Create `docs/handoffs/2025-10-13-ttrc231-complete.md`
- [ ] Summary of what was built
- [ ] Test results
- [ ] Performance metrics
- [ ] Any issues encountered
- [ ] Next steps (TTRC-232)

### Code Documentation
- [ ] Add JSDoc comments to new functions
- [ ] Update README if needed
- [ ] Document any environment variables
- [ ] Document cron schedules

---

## Definition of Done

- [ ] All tasks above completed
- [ ] All tests passing
- [ ] AI code review passed
- [ ] JIRA updated
- [ ] Handoff document created
- [ ] No regressions
- [ ] Performance <500ms p95
- [ ] Cost still $0
- [ ] Ready for PROD (but staying on TEST per project rules)

---

**Last Updated:** 2025-10-13
**Status:** Not Started - Ready for Next Session
**Next Session:** Start with task 1 (Lifecycle Management)
