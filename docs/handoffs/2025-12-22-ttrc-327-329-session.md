# Session Handoff - 2025-12-22

**Date:** 2025-12-22
**Branch:** test

---

## Summary

Completed TTRC-327 (time-block filter), analyzed clustering fragmentation, and implemented TTRC-329 (shadow policy evaluation for threshold tuning).

---

## Commits This Session

| Commit | Description |
|--------|-------------|
| `75b5657` | TTRC-327: Time-block filter uses latest_article_published_at |
| `ca212ad` | Fix: Add order clause for deterministic time-block results |
| `d6f206e` | TTRC-329: Shadow policy diff logging for threshold evaluation |

---

## TTRC-327: Complete

**Status:** Ready for Prod

Changed candidate-generation.js time-block filter from `last_updated_at` to `latest_article_published_at`. AI code review passed.

---

## TTRC-329: Shadow Policy Evaluation (NEW)

**Status:** In Progress (data collection phase)

### Why This Exists

Initial analysis suggested lowering Tier B threshold from 0.90 to 0.88, but:
1. Sampling was biased toward obvious fragmentation cases
2. Clustering runs pre-enrichment, we analyzed post-enrichment data
3. Entity overlap is unreliable at clustering time

### What Was Implemented

Shadow policy diff logging that:
- Tests thresholds 0.86, 0.87, 0.88, 0.89 in parallel
- Logs ONLY when shadow would ATTACH but live would CREATE
- Includes entity snapshots at clustering time
- Applies safety rule: title-only corroboration requires embed >= 0.90

### Next Steps (for next session)

1. **Trigger RSS workflow** to start collecting SHADOW_POLICY_DIFF logs
2. **Collect 2-3 days of data**
3. **Sample 30-60 riskiest cases** (lowest embed, title-only, longest time)
4. **Manual label**: SAME_EVENT / SAME_SAGA_DIFFERENT_EVENT / DIFFERENT_EVENT
5. **Pick threshold** with <= 1 FP per 100 merges

### Log Format

```json
{
  "type": "SHADOW_POLICY_DIFF",
  "article_id": "...",
  "article_title": "...",
  "best_candidate_id": 15886,
  "best_candidate_headline": "...",
  "embed_best": 0.901,
  "corroboration_type": "entity|slug|title_only|none",
  "article_entities_count": 2,
  "story_entities_count": 5,
  "shadow_results": {
    "tierB_0_86": true,
    "tierB_0_87": true,
    "tierB_0_88": true,
    "tierB_0_89": true
  }
}
```

---

## JIRA Status

| Ticket | Summary | Status |
|--------|---------|--------|
| TTRC-321 | Same-run high-embedding override | Ready for Prod |
| TTRC-324 | Two-tier cross-run override | In Review |
| TTRC-325 | Seed entity_counter with primary_actor | Ready for Prod |
| TTRC-326 | latest_article_published_at column | Ready for Prod |
| TTRC-327 | Time-block filter update | Ready for Prod |
| TTRC-328 | Evaluate recency filters (future) | Backlog |
| TTRC-329 | Shadow policy evaluation | In Progress |

---

## Key Insights from Analysis

1. **Entity overlap unreliable at clustering time** - NEAR_MISS showed `entity: false` even when stories later shared `US-VANCE`

2. **Corroboration strength ranking**:
   - slug_token (strongest)
   - entity_overlap (strong if available)
   - title_token (weakest - requires embed >= 0.90)

3. **Many blocks due to 48h time cutoff** - Consider 72h for Tier B with strong corroboration after data review

---

## Files Modified

| File | Changes |
|------|---------|
| `scripts/rss/candidate-generation.js` | TTRC-327 time filter |
| `scripts/rss/hybrid-clustering.js` | TTRC-329 shadow logging |
| `docs/plans/ttrc-329-shadow-policy-evaluation.md` | Detailed plan |

---

## Next Session Prompt

```
READ: docs/handoffs/2025-12-22-ttrc-327-329-session.md

## Context
TTRC-329 shadow policy logging is deployed. Need to collect data.

## Tasks
1. Trigger RSS workflow to start data collection
2. After 2-3 days, analyze SHADOW_POLICY_DIFF logs
3. Sample riskiest cases for manual review
4. Pick Tier B threshold based on FP rate

## Check AI code review
bash scripts/check-code-review.sh
```
