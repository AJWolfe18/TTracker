# TTRC-331 Ready for Implementation

**Date:** 2025-12-26
**Status:** Plan approved, ready to implement

---

## What Was Done

1. Reviewed TTRC-329 investigation results (7 false negatives, all blocked by margin)
2. Created detailed implementation plan with expert review
3. Multiple rounds of feedback incorporated:
   - Pre-bypass state for accurate logging
   - `blocked_by` computed from booleans (not hardcoded)
   - Separate raw vs final margin fields
   - wouldBypass computed before bypass mutation
   - Shadow log rate limiting with module-scope counter
   - Safe `secondCandidate?.story_id ?? null` access

## Key Documents

| File | Purpose |
|------|---------|
| `docs/plans/margin-gate-fix.md` | Complete implementation plan |

## JIRA Tickets

| Ticket | Description | Status |
|--------|-------------|--------|
| TTRC-329 | Shadow policy investigation | Done |
| TTRC-331 | Tier B margin bypass + logging | Ready for implementation |
| TTRC-332 | Duplicate-aware tie-break (future) | Backlog |

---

## Next Session Prompt

```
READ: docs/plans/margin-gate-fix.md

## Context
TTRC-331: Tier B Margin Bypass + Improved Logging

## Task
Implement the plan in scripts/rss/hybrid-clustering.js:

1. Add constants + module-scope shadow counter
2. Add buildBlockedBy() helper
3. marginVacuous fix with pre-bypass state
4. Compute wouldBypass BEFORE bypass mutation
5. Add Tier B bypass logic (feature-flagged)
6. Add TIERB_BYPASS_SHADOW logging
7. Update CROSS_RUN_NEAR_MISS with new fields
8. Push to test, run RSS workflow, verify logs
9. Update JIRA TTRC-331

## Key file
scripts/rss/hybrid-clustering.js (lines 640-805)

## Critical guardrail
Final attach block MUST still require passesCorroboration
```

---

## Critical Implementation Notes

1. **marginVacuous fix changes behavior immediately** (not feature-flagged)
   - Single-candidate cases will now merge
   - Call out in PR description

2. **Rate limit counter MUST be module-scope**
   - If inside article loop, resets per-article = spam

3. **blocked_by uses raw margin** (`tierBMarginOk_preBypass`)
   - Shows true failures even if bypassed
   - Combine with `bypass_applied` for full picture

4. **wouldBypass computed BEFORE bypass mutation**
   - Uses `tierBMarginOk_preBypass`, not `tierBMarginOk`
   - Same for shadow logging `marginIsBlocker`

---

*Created: 2025-12-26*
