# TTRC-302: Topic Slug Canonicalization - Partial Complete

**Date:** 2025-12-15
**Status:** Code Complete, Backfill Partial, Recluster Deferred
**Commit:** `92ea810`
**Branch:** test

---

## Summary

Implemented synonym-based slug canonicalization to reduce drift (e.g., CONFIRMATION → CONFIRM). Fixed egress issues in clustering. Backfill ~52% complete, recluster deferred due to egress concerns.

## What Was Done

### Code Changes (All Committed)

| File | Change |
|------|--------|
| `scripts/rss/topic-extraction.js` | Added synonym canonicalization map (CONFIRM, HEAR, NOMINATE, etc.) |
| `scripts/backfill-topic-slugs.mjs` | Fixed to use `content` field + added `--force` flag |
| `scripts/rss/hybrid-clustering.js` | Removed `select('*')` - now fetches only needed fields (saves ~5KB/article) |

### Backfill Status

- **Total articles:** 1,972
- **With slugs:** 1,038 (52.6%)
- **Without slugs:** 934 (47.4%)
- **OpenAI cost:** ~$1.50

### Why Partial

The `--force` flag without pagination kept re-processing the same 1000 oldest articles. Need to either:
1. Run without `--force` to fill remaining NULLs, OR
2. Add pagination to backfill script

---

## Next Session Tasks

1. **Finish backfill:** `node scripts/backfill-topic-slugs.mjs` (no --force, will process NULL slugs only)
   - May need multiple runs due to 1000 row Supabase limit

2. **Run recluster:**
   ```bash
   gh workflow disable "RSS Tracker - TEST"
   node scripts/recluster-all.mjs
   gh workflow enable "RSS Tracker - TEST"
   ```

3. **Validate with queries:**
   - Slug coverage: `SELECT COUNT(*) FILTER (WHERE topic_slug IS NOT NULL) FROM articles`
   - Over-generic slugs: Check for slugs with >20 articles
   - Drift families: Use pg_trgm similarity query (in plan file)

4. **Update JIRA TTRC-302 → Done**

---

## Egress Warning

User reported 7GB egress already used this month (free tier = 5GB). Be cautious with:
- Recluster fetches embeddings (~6KB/article × 2000 = ~12MB)
- Each clustering also queries story candidates with centroids

---

## Files Changed

```
scripts/rss/topic-extraction.js      +70 lines (canonicalization)
scripts/backfill-topic-slugs.mjs     +15 lines (content fix, --force)
scripts/rss/hybrid-clustering.js     +3 lines (egress optimization)
```

---

## JIRA Status

- **TTRC-302:** In Progress (move to Done after recluster)
- **TTRC-306:** Related ticket (original implementation)

---

## Key Design Decisions

1. **Synonym map over Porter stemming** - Preserves human-readable slugs (HEGSETH-CONFIRM-HEAR not HEGSETH-CONFIRM-HEAR)
2. **Skip tokens** - DOJ, FBI, short words, numbers preserved as-is
3. **Egress optimization** - Clustering no longer fetches content/excerpt fields
