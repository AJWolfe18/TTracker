# Handoff: TTRC-354 Fix & JIRA Cleanup Session

**Date:** 2025-12-31
**Branch:** test
**Commits:** 1e468e1, 8fe96b1

---

## What Was Done

### 1. TTRC-354 Fix Implemented

**Problem:** Articles orphaned when story creation fails with duplicate hash constraint.

**Fix:** In `createNewStory()`, catch hash collision errors and attach to existing story instead of throwing.

**Key details:**
- Robust detection: checks `createError.code`, `.constraint`, `.message`, `.details`
- Uses `maybeSingle()` for cleaner null handling
- Distinct `[TTRC-354]` log prefix for monitoring

**Validation (Run 20624596975):**
```
[TTRC-354] story_hash collision (hash=558c084f) for "Tracking who Trump is appointing..."
[TTRC-354] Recovered: attaching article to existing story id=13783
```

2 hash collision recoveries - fix working!

### 2. TTRC-336 Shadow Run #2

**Results:**
- 10 batch dedup decisions
- 9 correct rejections (title_token=0)
- 1 shadow attach (embed 0.911, title_token 2 - borderline)
- 0 false positives, 0 false negatives

**Status:** 2 clean runs post-threshold-fix. 1 more recommended before live.

### 3. JIRA Cleanup

| Ticket | Action | Reason |
|--------|--------|--------|
| TTRC-354 | → Ready for Test | Fix validated |
| TTRC-320 | → Ready for Prod | Already fixed Dec 19, was still in Backlog |
| TTRC-330 | → Cancelled | Duplicate of TTRC-354 |
| TTRC-258 | → Ready for Prod | Article scraping validated working |
| TTRC-260 | → Ready for Prod | Readability upgrade validated working |

---

## Current Ticket State

### Ready for Prod
- TTRC-258 (Article scraping)
- TTRC-260 (Readability upgrade)
- TTRC-320 (Embedding order fix)
- TTRC-321 (Same-run override)
- TTRC-323 (Exact title match)
- TTRC-324 (Tiered guardrails)
- TTRC-333 (Title token bypass)

### Ready for Test
- TTRC-354 (Hash collision fix)

### In Progress
- TTRC-336 (Batch dedup - 1 more shadow run)

### Closed This Session
- TTRC-330 (Duplicate of 354)

---

## Key Findings

### Previous Handoff Had Stale Info
- TTRC-320 listed as bug → Already fixed Dec 19
- TTRC-254 listed as pending → Already complete Nov 12

### Merge Quality Analysis (Run 20624596975)
- 5 correct attaches (3 TTRC-324, 2 TTRC-323)
- 5 correct rejections (time filter blocking old stories)
- 2 TTRC-354 recoveries
- 0 false positives/negatives

### Article Scraping Validated
- Guardian, Politico articles being scraped with full content
- Mozilla Readability working correctly

---

## Files Changed

- `scripts/rss/hybrid-clustering.js` (+46 lines) - hash collision handler

---

## Next Session

1. **Trigger one more RSS run** for TTRC-336 validation
2. **If clean:** Flip `BATCH_DEDUP_SHADOW_MODE=false` in workflow
3. **Review full ticket list** for prod PR (more than just clustering tickets)

---

## Commands Reference

```bash
# Trigger RSS run
gh workflow run "RSS Tracker - TEST" --ref test

# Check batch dedup logs
gh run view [RUN_ID] --log 2>&1 | grep "BATCH_DEDUP\|TTRC-354"

# Flip to live mode (edit workflow)
# .github/workflows/rss-tracker-test.yml
# BATCH_DEDUP_SHADOW_MODE: 'false'
```
