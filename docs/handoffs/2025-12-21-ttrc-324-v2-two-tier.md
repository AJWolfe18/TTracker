# TTRC-324 v2: Two-Tier Cross-Run Override

**Date:** 2025-12-21
**Status:** Plan approved, implementation pending
**Branch:** test

---

## Session Summary

### What Was Implemented (v1)
- TTRC-323: Same-run exact title dedup ✅
- TTRC-324: Cross-run slug+embed override ✅ (but slug gate too strict)
- TTRC-325: Entity seeding with primary_actor ✅
- CLUSTERING_SUMMARY logging ✅

**Commits:**
- `763fc4d` - feat(clustering): TTRC-323/324/325 clustering dedup improvements
- `a266bd1` - fix(clustering): add CLUSTERING_SUMMARY to RSS tracker logs

### Problem Discovered
Epstein articles have embeddings ~0.80-0.88 with existing stories, but **different slugs**:
- `EPSTEIN-DOCS-RELEASE`
- `EPSTEIN-FILES-REMOVED-TRUMP`
- `CLINTON-EPSTEIN-PHOTOS-RELEASE`

Current TTRC-324 requires slug match, so it never fires. Created 10+ Epstein stories instead of 1-2.

---

## v2 Plan: Two-Tier Safety Profile

### Tier A - Very High Embedding (no corroboration needed)
```
embedBest >= 0.90
timeDiff <= 48h
margin >= 0.04
passesGuardrail
```

### Tier B - High Embedding (needs corroboration)
```
embedBest >= 0.88
timeDiff <= 72h
margin >= 0.04
passesGuardrail
AND one of:
  - slugTokenSimilarity.passes
  - entityOverlapCount >= 1
  - titleTokenOverlap >= 1 (shared token length >= 5)
```

---

## Next Session Prompt

```
READ: docs/handoffs/2025-12-21-ttrc-324-v2-two-tier.md
READ: docs/plans/ttrc-324-325-322-clustering-overrides.md

## Task: Implement TTRC-324 v2 (Two-Tier Override)

Current TTRC-324 requires slug match, blocking valid Epstein-class merges.

### Implementation Steps:
1. Add `getTitleTokenOverlap(title1, title2)` helper
   - Normalize titles (lowercase, split on non-alphanum)
   - Count shared tokens with length >= 5
   - Return count

2. Refactor TTRC-324 to two-tier system:
   - Tier A: embed >= 0.90 + 48h + margin + guardrail → attach
   - Tier B: embed >= 0.88 + 72h + margin + guardrail + corroboration → attach
   - Corroboration = slugToken.passes OR entityOverlap >= 1 OR titleTokenOverlap >= 1

3. Update logging:
   - type: 'CROSS_RUN_OVERRIDE'
   - tier: 'A' or 'B'
   - corroboration: 'slug_token' | 'entity' | 'title_token' | null

4. Update CLUSTERING_SUMMARY to track:
   - attached_324_tier_a
   - attached_324_tier_b

5. Test with RSS run
6. Commit and push

### Success Criteria:
- Epstein-class articles attach instead of creating new stories
- Spot-check 20 overrides for false positives
- Attach rate increases

### Files to Modify:
- scripts/rss/hybrid-clustering.js (main logic)
- scripts/rss-tracker-supabase.js (summary logging)

### JIRA:
- Update TTRC-324 with v2 comment (auth may need refresh via /mcp)
```

---

## Key Context

- Cloud ID: `f04decff-2283-43f1-8e60-008935b3d794`
- RSS workflow runs on test branch via: `gh workflow run "RSS Tracker - TEST" --ref test`
- AI code review runs automatically on push
- Current attach rate: 0% (all articles creating new stories)
- Target: Material improvement in attach rate

---

## Deferred Work

- **Retroactive consolidation job**: Only if v2 doesn't fix fragmentation after 2-3 runs
- **Slug canonicalization**: Optional, embeddings are primary signal
