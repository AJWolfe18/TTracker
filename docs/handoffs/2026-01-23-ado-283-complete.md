# Handoff: ADO-283 Full Opinion Architecture - Testing

**Date:** 2026-01-23
**Branch:** test
**Status:** TESTING - Full pipeline validated on TEST, awaiting feature completion

---

## What Was Done

### ADO-283: Full Opinion Architecture - VALIDATED

**Goal:** Switch from extracted syllabus (~5K chars) to full opinion text (25-92K chars) for SCOTUS enrichment.

**Testing Completed:**

1. **Fetch Pipeline** - Fetched 3 new cases from CourtListener with full opinions
   - Opinions stored in `scotus_opinions` table
   - `source_data_version` set to `v2-full-opinion`

2. **Enrichment Pipeline** - Tested with Connelly v. United States
   - Pass 0 correctly used 25,568 chars (full opinion) instead of ~5K syllabus
   - High confidence extraction
   - Auto-published (is_public: true)

3. **Backfill Script** - Fixed ordering, backfilled 3 existing v1 cases
   - Added `ORDER BY decided_at DESC` to process recent cases first
   - Successfully backfilled FDA v. Alliance (91K), Campos-Chaves (88K), Starbucks (65K)

**5 Cases Now Using v2-full-opinion:**

| Case | Opinion Size |
|------|-------------|
| FDA v. Alliance for Hippocratic Medicine | 91,722 chars |
| Campos-Chaves v. Garland | 87,987 chars |
| Starbucks Corp. v. McKinney | 64,843 chars |
| Truck Insurance Exchange v. Kaiser Gypsum Co. | 39,812 chars |
| Connelly v. United States | 25,568 chars |

---

## Commits This Session

| SHA | Description |
|-----|-------------|
| `c50fc0e` | fix(ado-283): order backfill by decided_at DESC for recent cases first |

---

## Architecture Summary

```
CourtListener API
    ↓ fetch-cases.js
scotus_cases + scotus_opinions (full text)
    ↓ getCasesToEnrich() with LEFT JOIN
enrich-scotus.js (Pass 0 uses opinion_full_text first)
    ↓
Enriched case with high confidence
```

**Key Design Decisions:**
- Separate `scotus_opinions` table prevents accidental egress on SELECT *
- Content hashing (SHA-256) enables skip-if-unchanged during backfill
- Token windowing: first 40K + last 30K for opinions >100K chars
- Version tracking: `source_data_version` distinguishes v1-syllabus from v2-full-opinion

---

## What's Next

### Remaining v1 Cases
- ~22 cases still on v1-syllabus (older 2020 cases may not have full text in CourtListener)
- Can run `node scripts/scotus/backfill-opinions.js --limit=50` to backfill more

### Re-enrichment (Optional)
- Cases already enriched with v1-syllabus could be re-enriched with full opinions
- Reset `enrichment_status = 'pending'` for cases you want to re-enrich

### PROD Deployment
- ADO-283 changes ready for promotion when SCOTUS feature goes live
- Files to cherry-pick: migration 069, opinion-utils.js, backfill-opinions.js, fetch-cases.js, scotus-fact-extraction.js

---

## ADO Status

- **ADO-283:** Testing (on TEST, being verified as part of SCOTUS feature)
- **ADO-85 (parent):** Active - SCOTUS enrichment epic continues

## Content Validation

The full opinion text was validated:
- CourtListener returns `010combined` type (all opinions in one document)
- Combined text includes dissents/concurrences in standard SCOTUS format
- Text contains markers like "Thomas, J., concurring" and "Thomas, J., dissenting"
- GPT can parse this standard formatting for fact extraction

---

## Session Stats

- **Token usage:** ~45K input, ~8K output
- **Cost:** ~$0.003 (1 enrichment test)
