# TTRC-324 v2: Two-Tier Cross-Run Override - Final Handoff

**Date:** 2025-12-21
**Status:** Implemented and validated
**Branch:** test

---

## What Was Implemented

### TTRC-324 v2: Two-Tier Cross-Run Override

Replaced v1's slug-gated approach with a two-tier system that fixes Epstein-class fragmentation:

**Tier A** (no corroboration needed):
- embedBest >= 0.90 (0.92 if single candidate)
- timeDiff <= 48h
- margin >= 0.04 (vacuously true if single candidate)
- passesGuardrail

**Tier B** (needs corroboration):
- embedBest >= 0.88
- timeDiff <= 72h
- margin >= 0.04 AND 2+ candidates
- passesGuardrail
- AND one of: slugToken.passes, entityOverlap >= 1, titleTokenOverlap >= 1

### Key Safety Features
- TITLE_STOPWORDS filters newsroom terms + opinion pieces
- ACRONYM_ALLOWLIST keeps DOJ, FBI, SEC (excludes 'who')
- Time safety valve uses first_seen_at if last_updated_at gap > 7 days
- Article time fallback: published_at → created_at
- Backwards compat in CLUSTERING_SUMMARY

### Diagnostic Logging
- **CROSS_RUN_OVERRIDE**: Logs when override fires (tier, gates, corroboration)
- **CROSS_RUN_NEAR_MISS**: Logs when embed >= 0.85 but override didn't fire (shows which gate failed)
- **Enhanced DECISION log**: Shows both top-by-total and top-by-embedding candidates

---

## Commits

| Commit | Description |
|--------|-------------|
| `be6ac5b` | TTRC-324 v2 two-tier override |
| `13bbf99` | AI code review blocker fixes |
| `f9d7b03` | Near-miss diagnostic logging |
| `b54ff43` | LOG_NEAR_MISS env flag |
| `12f39e2` | Env vars documentation |

---

## Validation Results

### First Run (20415959023)
- **5 CROSS_RUN_OVERRIDEs** (4 Tier A, 1 Tier B)
- All 5 merges manually verified as correct:
  - 2 articles → Story 15844 (Epstein/Trump photo removal)
  - 2 articles → Story 15661 (Turning Point/MAGA infighting)
  - 1 article → Story 15890 (Epstein files disappearing)

### Issue Discovered
- Story 15890 should have merged with 15844 (same event)
- NYT article created 15890 instead of attaching to 15844
- ANN shows 0.91 similarity, but override didn't fire
- Near-miss logging now in place to catch future cases

### Second Run (20416438705)
- Near-miss logging working correctly
- Captured case with embed 0.871 < 0.88 (correctly didn't fire)

---

## JIRA Status

| Ticket | Status |
|--------|--------|
| TTRC-324 | Comment added with v2 implementation details |
| TTRC-326 | Created (latest_article_published_at follow-up, parent: TTRC-225) |

---

## Environment Variables Added

| Variable | Default | Description |
|----------|---------|-------------|
| `LOG_NEAR_MISS` | `true` | Enable CROSS_RUN_NEAR_MISS logging |
| `LOG_PHASE0_DIAGNOSTICS` | `false` | Enable Phase 0 diagnostic logging |

To disable near-miss logging after debugging:
```yaml
env:
  LOG_NEAR_MISS: 'false'
```

---

## Next Steps

### Immediate (Next Session)
1. **Monitor 2-3 more RSS runs** for near-miss logs
2. **Check AI code review** for commit 12f39e2
3. **Spot-check any new CROSS_RUN_OVERRIDEs** for false positives

### Short-term
4. **TTRC-326**: Implement `latest_article_published_at` column for better time anchoring
5. **Consider manual merge** of stories 15844/15890 if consolidation needed
6. **Disable LOG_NEAR_MISS** once debugging complete

### If False Negatives Persist
7. Lower Tier B threshold from 0.88 to 0.86
8. Add more corroboration signals (e.g., actor overlap)
9. Consider retroactive consolidation job

---

## Files Modified

| File | Changes |
|------|---------|
| `scripts/rss/hybrid-clustering.js` | Two-tier override, near-miss logging, env flags |
| `scripts/rss-tracker-supabase.js` | CLUSTERING_SUMMARY with tier breakdown |
| `docs/guides/development/environment-variables-setup.md` | Added new env vars |
| `docs/plans/ttrc-324-v2-two-tier.md` | Plan doc |

---

## Next Session Prompt

```
READ: docs/handoffs/2025-12-21-ttrc-324-v2-final.md

## Task: Monitor TTRC-324 v2 and Continue

1. Check AI code review for latest commits
2. Trigger RSS workflow and check for:
   - CROSS_RUN_OVERRIDE events (validate 2-3 merges)
   - CROSS_RUN_NEAR_MISS events (investigate if any)
3. If override working well, consider:
   - Manual merge of 15844/15890
   - Starting TTRC-326 (latest_article_published_at)
4. After 3-5 clean runs, disable LOG_NEAR_MISS
```

---

## Key Context

- Cloud ID: `f04decff-2283-43f1-8e60-008935b3d794`
- RSS workflow: `gh workflow run "RSS Tracker - TEST" --ref test`
- AI code review runs automatically on push
