# Test Environment - Executive Orders Tracker Manual Run
# Manual trigger for testing the executive orders tracker in test environment

name: Test Environment - Executive Orders

on:
  workflow_dispatch:
    inputs:
      backfill_days:
        description: 'Days to backfill (0 for today only)'
        required: false
        default: '0'
        type: string

jobs:
  test-executive-orders:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout test branch
      uses: actions/checkout@v4
      with:
        ref: test  # Always use test branch
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Import Executive Orders (raw data)
      env:
        ENVIRONMENT: test
        TARGET_ENV: test
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
        BACKFILL_DAYS: ${{ github.event.inputs.backfill_days }}
      run: |
        echo "üß™ Running executive orders tracker in TEST environment..."
        echo "üìç Using test database"
        echo "üìÖ Backfill days: $BACKFILL_DAYS"
        echo "üì¶ Phase 1: Import raw data from Federal Register"
        node scripts/executive-orders-tracker-supabase.js

    - name: Enrich Executive Orders (GPT)
      env:
        ENVIRONMENT: test
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
      run: |
        echo "ü§ñ Phase 2: AI enrichment with tone system"
        echo "üìù Generating summary, alarm_level, sections, actions..."
        node scripts/enrichment/enrich-executive-orders.js 50

    - name: Summary
      run: |
        echo "‚úÖ Test executive orders pipeline completed"
        echo "üß™ Environment: TEST"
        echo "üì¶ Phase 1: Raw data import"
        echo "ü§ñ Phase 2: GPT enrichment (tone system)"
