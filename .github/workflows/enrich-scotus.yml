name: Enrich SCOTUS (single case)

on:
  workflow_dispatch:
    inputs:
      case_id:
        description: "SCOTUS case ID"
        required: true
        type: string
      environment:
        description: "Which environment to run against"
        required: true
        type: choice
        options:
          - test
          - prod

jobs:
  enrich_single:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Create logs dir
        run: mkdir -p logs

      - name: Validate case_id
        env:
          INPUT_CASE_ID: ${{ inputs.case_id }}
        run: |
          set -euo pipefail
          if ! [[ "${INPUT_CASE_ID}" =~ ^[0-9]+(,[0-9]+)*$ ]]; then
            echo "Error: case_id must be numeric (or comma-separated numeric IDs)"
            exit 1
          fi

      - name: Enrich (TEST)
        if: inputs.environment == 'test'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_TEST_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_TEST_SERVICE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
          INPUT_CASE_ID: ${{ inputs.case_id }}
        run: |
          set -euo pipefail
          node scripts/scotus/enrich-scotus.js --case-ids="${INPUT_CASE_ID}" 2>&1 | tee logs/enrich-test.log

      - name: Enrich (PROD)
        if: inputs.environment == 'prod'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          INPUT_CASE_ID: ${{ inputs.case_id }}
        run: |
          set -euo pipefail
          node scripts/scotus/enrich-scotus.js --case-ids="${INPUT_CASE_ID}" --prod 2>&1 | tee logs/enrich-prod.log

      - name: Upload logs on failure/cancel
        if: failure() || cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: enrich-scotus-logs
          path: logs
