name: Test Real RSS Pipeline
on: 
  workflow_dispatch:
  push:
    branches: [test]
  pull_request:
    branches: [test]

jobs:
  test-real-rss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Test Real RSS Pipeline
        env:
          NODE_ENV: test
          SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
        run: |
          echo "üöÄ Starting REAL RSS test - fetching actual feeds from database"
          
          # Create inline test that actually fetches and stores
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const Parser = require('rss-parser');
          const parser = new Parser();
          
          const supabase = createClient(
            process.env.SUPABASE_URL,
            process.env.SUPABASE_SERVICE_ROLE_KEY
          );
          
          async function testRealRSS() {
            console.log('üì° Fetching active RSS feeds from database...');
            
            // Get real feeds from your database
            const { data: feeds, error } = await supabase
              .from('feed_registry')
              .select('*')
              .eq('is_active', true);
              
            if (error) throw error;
            console.log('Found', feeds.length, 'active feeds');
            
            let totalArticles = 0;
            
            // Test each feed
            for (const feed of feeds) {
              console.log('\\nüîÑ Testing:', feed.feed_name);
              try {
                const rssFeed = await parser.parseURL(feed.feed_url);
                console.log('  ‚úÖ Fetched', rssFeed.items.length, 'articles');
                
                // Store first 3 articles as test
                for (let i = 0; i < Math.min(3, rssFeed.items.length); i++) {
                  const item = rssFeed.items[i];
                  
                  // Store directly in political_entries table with CORRECT columns
                  const { data, error } = await supabase
                    .from('political_entries')
                    .insert({
                      id: 'pe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                      title: item.title || 'Untitled',
                      url: item.link || item.guid,
                      url_canonical: item.link || item.guid,
                      source_domain: new URL(feed.feed_url).hostname.replace('www.', ''),
                      source_name: feed.feed_name,
                      source: feed.feed_name,
                      published_at: item.pubDate ? new Date(item.pubDate).toISOString() : new Date().toISOString(),
                      excerpt: (item.contentSnippet || item.content || '').substring(0, 500),
                      category: 'other',
                      content_type: 'article',
                      severity_level: 'medium',
                      processed: false
                    })
                    .select();
                  
                  if (!error && data) {
                    totalArticles++;
                    console.log('  üìù Stored:', item.title.substring(0, 50) + '...');
                  } else {
                    console.log('  ‚ö†Ô∏è Store failed:', error?.message || 'Unknown error');
                  }
                }
              } catch (err) {
                console.log('  ‚ùå Feed failed:', err.message);
              }
            }
            
            console.log('\\n‚úÖ TOTAL ARTICLES STORED:', totalArticles);
            
            // Verify they're in the database
            const { data: recent, error: checkError } = await supabase
              .from('political_entries')
              .select('title, source_domain, created_at')
              .order('created_at', { ascending: false })
              .limit(10);
              
            if (recent && recent.length > 0) {
              console.log('\\nüìä Latest entries in database:');
              recent.forEach(entry => {
                console.log(' -', entry.source_domain + ':', (entry.title || '').substring(0, 50));
              });
            } else {
              console.log('\\n‚ö†Ô∏è No recent entries found in database');
            }
          }
          
          testRealRSS().catch(console.error);
          "
