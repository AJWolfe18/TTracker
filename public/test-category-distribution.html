<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Distribution Checker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        button:hover {
            background: #45a049;
        }
        .results {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
        }
        .category-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .valid {
            color: #4CAF50;
        }
        .invalid {
            color: #ff6b6b;
        }
        .count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 14px;
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
    <script src="supabase-browser-config.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîç Category Distribution Checker</h1>
        <p style="text-align: center;">Check how categories are currently distributed in the database</p>
        
        <button onclick="checkCategories()">Check Category Distribution</button>
        
        <div id="results" class="results" style="display: none;">
            <div id="loading" class="loading">Loading...</div>
            <div id="content" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Valid 11 categories
        const VALID_CATEGORIES = [
            'corruption_scandals',
            'democracy_elections',
            'policy_legislation',
            'justice_legal',
            'executive_actions',
            'foreign_policy',
            'corporate_financial',
            'civil_liberties',
            'media_disinformation',
            'epstein_associates',
            'other'
        ];

        // Display names
        const CATEGORY_DISPLAY = {
            'corruption_scandals': 'Corruption & Scandals',
            'democracy_elections': 'Democracy & Elections',
            'policy_legislation': 'Policy & Legislation',
            'justice_legal': 'Justice & Legal',
            'executive_actions': 'Executive Actions',
            'foreign_policy': 'Foreign Policy',
            'corporate_financial': 'Corporate & Financial',
            'civil_liberties': 'Civil Liberties',
            'media_disinformation': 'Media & Disinformation',
            'epstein_associates': 'Epstein & Associates',
            'other': 'Other'
        };

        async function checkCategories() {
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const contentDiv = document.getElementById('content');
            
            resultsDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            
            try {
                // Get all entries with their categories
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/political_entries?select=id,category`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const entries = await response.json();
                
                // Count categories
                const categoryCount = {};
                const invalidCategories = new Set();
                let totalEntries = entries.length;
                
                entries.forEach(entry => {
                    const cat = entry.category || 'null';
                    categoryCount[cat] = (categoryCount[cat] || 0) + 1;
                    
                    if (!VALID_CATEGORIES.includes(cat) && cat !== 'null') {
                        invalidCategories.add(cat);
                    }
                });
                
                // Sort by count
                const sorted = Object.entries(categoryCount)
                    .sort((a, b) => b[1] - a[1]);
                
                // Generate HTML
                let html = `<h2>üìä Category Distribution (${totalEntries} total entries)</h2>`;
                
                // Show each category
                html += '<div class="category-list">';
                sorted.forEach(([cat, count]) => {
                    const percentage = ((count / totalEntries) * 100).toFixed(1);
                    const isValid = VALID_CATEGORIES.includes(cat);
                    const displayName = CATEGORY_DISPLAY[cat] || cat;
                    const icon = isValid ? '‚úÖ' : '‚ùå';
                    const className = isValid ? 'valid' : 'invalid';
                    
                    html += `
                        <div class="category-item">
                            <span class="${className}">
                                ${icon} <strong>${displayName}</strong> 
                                ${!isValid ? `(should be mapped)` : ''}
                            </span>
                            <span class="count">${count} (${percentage}%)</span>
                        </div>
                    `;
                });
                html += '</div>';
                
                // Summary
                const validCount = sorted.filter(([cat]) => VALID_CATEGORIES.includes(cat)).length;
                const invalidCount = invalidCategories.size;
                
                html += `
                    <div class="summary">
                        <h3>Summary:</h3>
                        <p>‚úÖ Valid categories in use: ${validCount} of 11</p>
                        <p>‚ùå Invalid categories found: ${invalidCount}</p>
                        ${invalidCount > 0 ? `
                            <p style="color: #ff6b6b;">
                                ‚ö†Ô∏è Migration needed! Run: <code>node scripts/migrate-political-categories.js</code>
                            </p>
                        ` : `
                            <p style="color: #4CAF50;">
                                ‚ú® All categories are valid!
                            </p>
                        `}
                    </div>
                `;
                
                // Show missing valid categories
                const usedCategories = Object.keys(categoryCount);
                const missingCategories = VALID_CATEGORIES.filter(cat => !usedCategories.includes(cat));
                
                if (missingCategories.length > 0) {
                    html += `
                        <div class="summary">
                            <h3>üìù Unused Valid Categories:</h3>
                            ${missingCategories.map(cat => `
                                <div>${CATEGORY_DISPLAY[cat]} (${cat})</div>
                            `).join('')}
                        </div>
                    `;
                }
                
                contentDiv.innerHTML = html;
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
                
            } catch (error) {
                contentDiv.innerHTML = `
                    <div style="color: #ff6b6b;">
                        ‚ùå Error: ${error.message}<br>
                        Make sure you're connected to the internet and Supabase is accessible.
                    </div>
                `;
                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
