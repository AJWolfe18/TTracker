<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archive Operation Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #1a202c;
            color: white;
        }
        .test-section {
            background: rgba(45, 55, 72, 0.6);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #4a5568;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #3182ce;
            color: white;
        }
        button:hover {
            background: #2563eb;
        }
        .log {
            background: #2d3748;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { border-left: 4px solid #38a169; }
        .error { border-left: 4px solid #e53e3e; }
        .info { border-left: 4px solid #3182ce; }
        input {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #4a5568;
            background: #2d3748;
            color: white;
        }
    </style>
    <script src="supabase-browser-config.js"></script>
</head>
<body>
    <h1>Archive Operation Test</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <div id="config-info"></div>
    </div>

    <div class="test-section">
        <h2>Direct PATCH Test</h2>
        <p>Enter an entry ID to test archive operation:</p>
        <input type="number" id="entry-id" placeholder="Entry ID (e.g., 1081)" value="1081">
        <select id="table-name">
            <option value="political_entries">Political Entries</option>
            <option value="executive_orders">Executive Orders</option>
        </select>
        <br><br>
        <button onclick="testDirectPatch(true)">Test Archive (set archived=true)</button>
        <button onclick="testDirectPatch(false)">Test Restore (set archived=false)</button>
        <button onclick="checkEntry()">Check Current Status</button>
        <button onclick="testRawFetch()">Test Raw Fetch</button>
    </div>

    <div class="test-section">
        <h2>Test Results</h2>
        <div id="logs"></div>
    </div>

    <script>
        // Display configuration
        document.getElementById('config-info').innerHTML = `
            <div class="log info">
                Environment: ${window.location.hostname.includes('test--') ? 'TEST' : 'PRODUCTION'}
                <br>Supabase URL: ${window.SUPABASE_URL}
                <br>Database: ${window.SUPABASE_URL.includes('wnrjrywpcadwutfykflu') ? 'TEST DB' : 'PRODUCTION DB'}
            </div>
        `;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
        }

        async function checkEntry() {
            const id = document.getElementById('entry-id').value;
            const table = document.getElementById('table-name').value;
            
            if (!id) {
                log('Please enter an entry ID', 'error');
                return;
            }

            try {
                log(`Checking ${table} entry ${id}...`, 'info');
                
                const response = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,
                    {
                        method: 'GET',
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                const data = await response.json();
                
                if (data && data.length > 0) {
                    log(`Entry found: archived = ${data[0].archived}, title = "${data[0].title || data[0].actor}"`, 'success');
                    log(`Full entry: ${JSON.stringify(data[0], null, 2)}`, 'info');
                } else {
                    log(`No entry found with ID ${id}`, 'error');
                }
            } catch (error) {
                log(`Error checking entry: ${error.message}`, 'error');
            }
        }

        async function testDirectPatch(archived) {
            const id = document.getElementById('entry-id').value;
            const table = document.getElementById('table-name').value;
            
            if (!id) {
                log('Please enter an entry ID', 'error');
                return;
            }

            try {
                log(`Testing PATCH to ${table} ID ${id}, setting archived=${archived}...`, 'info');
                
                const url = `${window.SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`;
                const body = JSON.stringify({ archived: archived });
                
                log(`URL: ${url}`, 'info');
                log(`Body: ${body}`, 'info');
                log(`Headers: apikey=${window.SUPABASE_ANON_KEY.substring(0, 20)}...`, 'info');
                
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'apikey': window.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: body
                });

                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log(`Response body: ${responseText || '(empty)'}`, 'info');
                log(`Response Content-Length: ${response.headers.get('content-length')} bytes`, 'info');
                
                // Check if the update actually worked
                setTimeout(() => checkEntry(), 1000);
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testRawFetch() {
            const id = document.getElementById('entry-id').value;
            const table = document.getElementById('table-name').value;
            
            if (!id) {
                log('Please enter an entry ID', 'error');
                return;
            }

            log('Testing with different Prefer headers...', 'info');
            
            // Test 1: No Prefer header
            try {
                const response1 = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ archived: true })
                    }
                );
                const text1 = await response1.text();
                log(`Without Prefer header: Status ${response1.status}, Body: ${text1 || '(empty)'}`, 'info');
            } catch (e) {
                log(`Error without Prefer: ${e.message}`, 'error');
            }

            // Test 2: With return=minimal
            try {
                const response2 = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ archived: false })
                    }
                );
                const text2 = await response2.text();
                log(`With return=minimal: Status ${response2.status}, Body: ${text2 || '(empty)'}`, 'info');
            } catch (e) {
                log(`Error with minimal: ${e.message}`, 'error');
            }

            // Test 3: Check RLS policies
            try {
                log('Checking RLS policies...', 'info');
                const response = await fetch(
                    `${window.SUPABASE_URL}/rest/v1/rpc/check_policies`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': window.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    }
                );
                const data = await response.text();
                log(`RLS check response: ${data}`, 'info');
            } catch (e) {
                log(`RLS check not available (this is normal)`, 'info');
            }

            // Final check
            setTimeout(() => checkEntry(), 1000);
        }

        // Auto-check on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Test page loaded. Enter an entry ID and click a test button.', 'info');
        });
    </script>
</body>
</html>