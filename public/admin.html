<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TrumpyTracker</title>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-browser-config.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        /* Header Styles */
        .header {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #334155;
        }
        .header-prod { background: #1e3a5f; }
        .header-test { background: #5f4b1e; }
        .header-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .budget-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .budget-ok { color: #4ade80; }
        .budget-warning { color: #fbbf24; }
        .budget-danger { color: #f87171; }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            padding: 12px 24px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .tab-btn:hover { background: #334155; color: #e2e8f0; }
        .tab-btn.active {
            background: #3b82f6;
            color: white;
        }

        /* Main Content */
        .main-content {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        /* Cards */
        .card {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body { padding: 20px; }

        /* Status Indicators */
        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #334155;
        }
        .status-row:last-child { border-bottom: none; }
        .status-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .status-icon { font-size: 18px; }
        .status-value {
            font-size: 14px;
            font-weight: 500;
        }
        .status-ok { color: #4ade80; }
        .status-warning { color: #fbbf24; }
        .status-error { color: #f87171; }
        .status-muted { color: #64748b; }

        /* Attention Items */
        .attention-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .attention-item:hover { background: #1e293b; transform: translateX(4px); }
        .attention-item:last-child { margin-bottom: 0; }
        .attention-count {
            background: #ef4444;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        .attention-count.zero {
            background: #334155;
            color: #64748b;
        }

        /* Activity Summary */
        .activity-stat {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
        }
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .activity-icon.stories { background: rgba(59, 130, 246, 0.2); }
        .activity-icon.articles { background: rgba(16, 185, 129, 0.2); }
        .activity-icon.enriched { background: rgba(168, 85, 247, 0.2); }
        .activity-number {
            font-size: 24px;
            font-weight: 600;
            color: #f8fafc;
        }
        .activity-label {
            font-size: 13px;
            color: #94a3b8;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .action-btn {
            padding: 12px 20px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .action-btn:hover {
            background: #1e293b;
            border-color: #3b82f6;
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Error State */
        .error-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            color: #fca5a5;
        }

        /* Auto-refresh indicator */
        .refresh-indicator {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
        }
        .login-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h1 {
            font-size: 22px;
            font-weight: 600;
            margin: 0 0 8px;
            color: #f8fafc;
        }
        .login-card p {
            color: #94a3b8;
            font-size: 14px;
            margin: 0 0 24px;
        }
        .login-input {
            width: 100%;
            padding: 12px 16px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            margin-bottom: 16px;
        }
        .login-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .login-btn {
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-btn:hover { background: #2563eb; }
        .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 16px;
            color: #fca5a5;
            font-size: 13px;
        }
        .signout-btn {
            background: none;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .signout-btn:hover { border-color: #ef4444; color: #f87171; }

        /* Stories Tab */
        .stories-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .stories-search {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }
        .stories-search:focus { outline: none; border-color: #3b82f6; }
        .stories-select {
            padding: 10px 14px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            cursor: pointer;
        }
        .stories-select:focus { outline: none; border-color: #3b82f6; }
        .stories-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .stories-table th {
            text-align: left;
            padding: 10px 12px;
            color: #94a3b8;
            font-weight: 500;
            border-bottom: 1px solid #334155;
            white-space: nowrap;
        }
        .stories-table td {
            padding: 12px;
            border-bottom: 1px solid #1e293b;
            vertical-align: top;
        }
        .stories-table tr:hover td { background: rgba(59, 130, 246, 0.05); }
        .stories-table .headline-cell {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            color: #e2e8f0;
        }
        .stories-table .headline-cell:hover { color: #3b82f6; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-active { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
        .badge-closed { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }
        .badge-archived { background: rgba(100, 116, 139, 0.15); color: #64748b; }
        .badge-enriched { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
        .badge-failed { background: rgba(248, 113, 113, 0.15); color: #f87171; }
        .badge-pending { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
        .load-more-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .load-more-btn:hover { background: #334155; color: #e2e8f0; }
        .load-more-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .stories-count {
            font-size: 13px;
            color: #64748b;
            padding: 8px 0;
        }
        .story-detail-row td {
            background: #0f172a;
            padding: 16px 12px;
        }
        .story-detail-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 13px;
        }
        .story-detail-content dt { color: #64748b; }
        .story-detail-content dd { color: #e2e8f0; margin: 0 0 8px; }
        .story-detail-content a { color: #3b82f6; text-decoration: none; }
        .story-detail-content a:hover { text-decoration: underline; }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 12px; }
            .quick-actions { flex-direction: column; }
            .action-btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // Environment detection
        function getEnvironment() {
            const url = window.SUPABASE_URL || '';
            if (url.includes('wnrjrywpcadwutfykflu')) {
                return { name: 'Test', isProd: false, label: 'Test Admin Dashboard' };
            }
            if (url.includes('osjbulmltfpcoldydexg')) {
                return { name: 'PROD', isProd: true, label: 'PROD Admin Dashboard' };
            }
            return { name: 'Unknown', isProd: false, label: 'Admin Dashboard' };
        }

        // Session storage key for admin password
        const AUTH_STORAGE_KEY = 'admin_password';

        // Stories Tab Component
        function StoriesTab({ password, supabase }) {
            const [stories, setStories] = useState([]);
            const [loading, setLoading] = useState(true);
            const [loadingMore, setLoadingMore] = useState(false);
            const [error, setError] = useState(null);
            const [cursor, setCursor] = useState(null);
            const [hasMore, setHasMore] = useState(false);

            // Filters
            const [search, setSearch] = useState('');
            const [debouncedSearch, setDebouncedSearch] = useState('');
            const [statusFilter, setStatusFilter] = useState('');
            const [enrichmentFilter, setEnrichmentFilter] = useState('');

            // Detail expansion
            const [expandedId, setExpandedId] = useState(null);

            // Debounce search input
            useEffect(() => {
                const timer = setTimeout(() => {
                    setDebouncedSearch(search);
                }, 500);
                return () => clearTimeout(timer);
            }, [search]);

            // Fetch stories from edge function
            const fetchStories = useCallback(async (append = false, pageCursor = null) => {
                if (append) {
                    setLoadingMore(true);
                } else {
                    setLoading(true);
                }
                setError(null);

                try {
                    const reqBody = { limit: 25 };
                    if (debouncedSearch) reqBody.search = debouncedSearch;
                    if (statusFilter) reqBody.status = statusFilter;
                    if (enrichmentFilter) reqBody.enrichment = enrichmentFilter;
                    if (pageCursor) reqBody.cursor = pageCursor;

                    const { data, error: fnError } = await supabase.functions.invoke(
                        'admin-stories',
                        {
                            headers: { 'x-admin-password': password },
                            body: reqBody
                        }
                    );

                    if (fnError) throw new Error(fnError.message || 'Failed to fetch stories');

                    if (append) {
                        setStories(prev => [...prev, ...(data.stories || [])]);
                    } else {
                        setStories(data.stories || []);
                    }

                    setCursor(data.pagination?.next_cursor || null);
                    setHasMore(data.pagination?.has_more || false);
                } catch (err) {
                    console.error('Stories fetch error:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                    setLoadingMore(false);
                }
            }, [supabase, password, debouncedSearch, statusFilter, enrichmentFilter]);

            // Re-fetch when filters change
            useEffect(() => {
                setCursor(null);
                setExpandedId(null);
                fetchStories(false, null);
            }, [fetchStories]);

            // Load more handler
            const handleLoadMore = () => {
                if (cursor && hasMore) {
                    fetchStories(true, cursor);
                }
            };

            // Format date for display
            const formatDate = (iso) => {
                if (!iso) return '-';
                const d = new Date(iso);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            const formatDateTime = (iso) => {
                if (!iso) return '-';
                const d = new Date(iso);
                return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
            };

            // Get enrichment badge
            const getEnrichmentBadge = (story) => {
                if (story.enrichment_failure_count > 0) {
                    return { class: 'badge-failed', label: `Failed (${story.enrichment_failure_count})` };
                }
                if (story.last_enriched_at) {
                    return { class: 'badge-enriched', label: 'Enriched' };
                }
                return { class: 'badge-pending', label: 'Pending' };
            };

            // Get status badge
            const getStatusBadge = (status) => {
                if (status === 'active') return { class: 'badge-active', label: 'Active' };
                if (status === 'closed') return { class: 'badge-closed', label: 'Closed' };
                if (status === 'archived') return { class: 'badge-archived', label: 'Archived' };
                return { class: 'badge-closed', label: status || 'Unknown' };
            };

            // Toggle detail expansion
            const toggleDetail = (id) => {
                setExpandedId(expandedId === id ? null : id);
            };

            return (
                <div>
                    {/* Toolbar: Search + Filters */}
                    <div className="stories-toolbar">
                        <input
                            type="text"
                            className="stories-search"
                            placeholder="Search headlines..."
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                        />
                        <select
                            className="stories-select"
                            value={statusFilter}
                            onChange={(e) => setStatusFilter(e.target.value)}
                        >
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="closed">Closed</option>
                            <option value="archived">Archived</option>
                        </select>
                        <select
                            className="stories-select"
                            value={enrichmentFilter}
                            onChange={(e) => setEnrichmentFilter(e.target.value)}
                        >
                            <option value="">All Enrichment</option>
                            <option value="enriched">Enriched</option>
                            <option value="failed">Failed</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>

                    {error && (
                        <div className="error-banner">
                            <strong>Error:</strong> {error}
                        </div>
                    )}

                    {loading ? (
                        <div className="loading">
                            <div className="spinner"></div>
                            Loading stories...
                        </div>
                    ) : (
                        <div className="card">
                            <div className="card-header">
                                <h2 className="card-title">Stories</h2>
                                <span className="stories-count">
                                    Showing {stories.length} stories
                                    {hasMore && ' (more available)'}
                                </span>
                            </div>
                            <div style={{ overflowX: 'auto' }}>
                                <table className="stories-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Headline</th>
                                            <th>Source</th>
                                            <th>Status</th>
                                            <th>Enrichment</th>
                                            <th>Articles</th>
                                            <th>Created</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {stories.length === 0 && (
                                            <tr>
                                                <td colSpan={7} style={{ textAlign: 'center', padding: '40px', color: '#64748b' }}>
                                                    No stories found matching your filters.
                                                </td>
                                            </tr>
                                        )}
                                        {stories.map(story => {
                                            const statusBadge = getStatusBadge(story.status);
                                            const enrichBadge = getEnrichmentBadge(story);
                                            const isExpanded = expandedId === story.id;

                                            return React.createElement(React.Fragment, { key: story.id },
                                                <tr>
                                                    <td style={{ color: '#64748b', fontSize: '13px' }}>{story.id}</td>
                                                    <td
                                                        className="headline-cell"
                                                        onClick={() => toggleDetail(story.id)}
                                                        title={story.primary_headline}
                                                    >
                                                        {story.primary_headline || '(No headline)'}
                                                    </td>
                                                    <td style={{ color: '#94a3b8', fontSize: '13px', whiteSpace: 'nowrap' }}>
                                                        {story.primary_source || '-'}
                                                    </td>
                                                    <td>
                                                        <span className={`badge ${statusBadge.class}`}>{statusBadge.label}</span>
                                                    </td>
                                                    <td>
                                                        <span className={`badge ${enrichBadge.class}`}>{enrichBadge.label}</span>
                                                    </td>
                                                    <td style={{ textAlign: 'center', color: '#94a3b8' }}>
                                                        {story.article_count}
                                                    </td>
                                                    <td style={{ color: '#94a3b8', fontSize: '13px', whiteSpace: 'nowrap' }}>
                                                        {formatDate(story.first_seen_at)}
                                                    </td>
                                                </tr>,
                                                isExpanded && (
                                                    <tr className="story-detail-row">
                                                        <td colSpan={7}>
                                                            <div className="story-detail-content">
                                                                <div>
                                                                    <dt>Category</dt>
                                                                    <dd>{story.category || '-'}</dd>
                                                                    <dt>Severity</dt>
                                                                    <dd>{story.severity || '-'}</dd>
                                                                    <dt>Source Count</dt>
                                                                    <dd>{story.source_count ?? '-'}</dd>
                                                                </div>
                                                                <div>
                                                                    <dt>Last Updated</dt>
                                                                    <dd>{formatDateTime(story.last_updated_at)}</dd>
                                                                    <dt>Last Enriched</dt>
                                                                    <dd>{formatDateTime(story.last_enriched_at)}</dd>
                                                                    <dt>Enrichment Failures</dt>
                                                                    <dd>{story.enrichment_failure_count}</dd>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            {hasMore && (
                                <div style={{ padding: '0 20px 20px' }}>
                                    <button
                                        className="load-more-btn"
                                        onClick={handleLoadMore}
                                        disabled={loadingMore}
                                    >
                                        {loadingMore ? 'Loading...' : 'Load More'}
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Main App Component
        function AdminDashboard() {
            const [activeTab, setActiveTab] = useState('home');
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastRefresh, setLastRefresh] = useState(null);
            const refreshIntervalRef = useRef(null);

            // Auth state
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [password, setPassword] = useState('');
            const [authError, setAuthError] = useState(null);
            const [authLoading, setAuthLoading] = useState(false);
            const [failedAttempts, setFailedAttempts] = useState(0);
            const [lockoutUntil, setLockoutUntil] = useState(null);

            const env = getEnvironment();

            // Check sessionStorage for existing password on mount
            useEffect(() => {
                const saved = sessionStorage.getItem(AUTH_STORAGE_KEY);
                if (saved) {
                    setPassword(saved);
                    setIsAuthenticated(true);
                }
            }, []);

            // Initialize Supabase client - memoize to prevent recreation on every render
            const supabase = useMemo(() => window.supabase.createClient(
                window.SUPABASE_URL,
                window.SUPABASE_ANON_KEY
            ), []);

            // Handle login attempt
            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError(null);

                // Rate limiting: block if locked out
                if (lockoutUntil && Date.now() < lockoutUntil) {
                    const secs = Math.ceil((lockoutUntil - Date.now()) / 1000);
                    setAuthError(`Too many attempts. Try again in ${secs}s.`);
                    return;
                }

                setAuthLoading(true);

                try {
                    const pw = e.target.elements.password.value;
                    // Test the password by calling admin-stats with it
                    const { data, error: fnError } = await supabase.functions.invoke('admin-stats', {
                        headers: { 'x-admin-password': pw }
                    });

                    if (fnError) {
                        // Supabase client wraps non-2xx as FunctionsHttpError
                        if (fnError.context?.status === 401 || fnError.message?.includes('Unauthorized')) {
                            const attempts = failedAttempts + 1;
                            setFailedAttempts(attempts);
                            if (attempts >= 3) {
                                const lockoutMs = Math.min(5000 * Math.pow(2, attempts - 3), 60000);
                                setLockoutUntil(Date.now() + lockoutMs);
                                setAuthError(`Invalid password. Locked out for ${lockoutMs / 1000}s.`);
                            } else {
                                setAuthError('Invalid password');
                            }
                            return;
                        }
                        throw fnError;
                    }

                    // Success - store password and show dashboard
                    setFailedAttempts(0);
                    setLockoutUntil(null);
                    sessionStorage.setItem(AUTH_STORAGE_KEY, pw);
                    setPassword(pw);
                    setIsAuthenticated(true);
                    setStats(data);
                    setLastRefresh(new Date());
                    setLoading(false);
                } catch (err) {
                    console.error('Login error:', err);
                    setAuthError(err.message || 'Authentication failed');
                } finally {
                    setAuthLoading(false);
                }
            };

            // Handle sign out
            const handleSignOut = () => {
                sessionStorage.removeItem(AUTH_STORAGE_KEY);
                setIsAuthenticated(false);
                setPassword('');
                setStats(null);
                setLoading(true);
                setError(null);
                if (refreshIntervalRef.current) {
                    clearInterval(refreshIntervalRef.current);
                }
            };

            // Fetch admin stats
            const fetchStats = useCallback(async () => {
                if (!password) return;

                try {
                    setError(null);

                    // Call the admin-stats edge function with password header
                    const { data, error: fnError } = await supabase.functions.invoke('admin-stats', {
                        headers: { 'x-admin-password': password }
                    });

                    if (fnError) {
                        // If 401, password is no longer valid - sign out
                        if (fnError.context?.status === 401 || fnError.message?.includes('Unauthorized')) {
                            handleSignOut();
                            setAuthError('Session expired. Please sign in again.');
                            return;
                        }
                        throw new Error(fnError.message || 'Failed to fetch stats');
                    }

                    setStats(data);
                    setLastRefresh(new Date());
                } catch (err) {
                    console.error('Error fetching stats:', err);
                    setError(err.message);

                    // If edge function fails, try direct queries as fallback
                    try {
                        await fetchStatsDirect();
                    } catch (fallbackErr) {
                        console.error('Fallback also failed:', fallbackErr);
                    }
                } finally {
                    setLoading(false);
                }
            }, [supabase, password]);

            // Fallback: Direct database queries
            const fetchStatsDirect = async () => {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();

                const [
                    storiesActive,
                    storiesEnrichFailed,
                    storiesToday,
                    articlesToday,
                    articlesTotal,
                    feedsData,
                    pardonsData,
                    scotusData,
                    eosTotal,
                    budgetData,
                    lastFetch
                ] = await Promise.all([
                    supabase.from('stories').select('id', { count: 'exact', head: true }).eq('status', 'active'),
                    supabase.from('stories').select('id', { count: 'exact', head: true }).gt('enrichment_failure_count', 0),
                    supabase.from('stories').select('id', { count: 'exact', head: true }).gte('first_seen_at', last24h),
                    supabase.from('articles').select('id', { count: 'exact', head: true }).gte('fetched_at', last24h),
                    supabase.from('articles').select('id', { count: 'exact', head: true }),
                    supabase.from('feed_registry').select('id,is_active,failure_count'),
                    supabase.from('pardons').select('id,is_public,needs_review'),
                    supabase.from('scotus_cases').select('id,is_public'),
                    supabase.from('executive_orders').select('id', { count: 'exact', head: true }),
                    supabase.from('budgets').select('*').eq('day', today).single(),
                    supabase.from('feed_registry').select('last_fetched_at').not('last_fetched_at', 'is', null).order('last_fetched_at', { ascending: false }).limit(1).single()
                ]);

                // Process feeds
                const feeds = feedsData.data || [];
                const feedsActive = feeds.filter(f => f.is_active && f.failure_count < 5).length;
                const feedsFailed = feeds.filter(f => f.failure_count >= 5).length;

                // Process pardons
                const pardons = pardonsData.data || [];
                const pardonsDraft = pardons.filter(p => !p.is_public).length;
                const pardonsNeedsReview = pardons.filter(p => p.needs_review).length;

                // Process SCOTUS
                const scotus = scotusData.data || [];
                const scotusDraft = scotus.filter(s => !s.is_public).length;

                // Pipeline status
                let pipelineStatus = 'unknown';
                let pipelineMessage = 'No recent runs';
                let minutesSinceLastRun = null;

                if (lastFetch.data?.last_fetched_at) {
                    const lastRunTime = new Date(lastFetch.data.last_fetched_at);
                    minutesSinceLastRun = Math.floor((now.getTime() - lastRunTime.getTime()) / 60000);

                    if (minutesSinceLastRun < 150) {
                        pipelineStatus = 'ok';
                        pipelineMessage = `${minutesSinceLastRun} min ago`;
                    } else if (minutesSinceLastRun < 240) {
                        pipelineStatus = 'warning';
                        pipelineMessage = `${minutesSinceLastRun} min ago (delayed)`;
                    } else {
                        pipelineStatus = 'error';
                        pipelineMessage = `${minutesSinceLastRun} min ago (stale!)`;
                    }
                }

                // Build stats object
                const budget = budgetData.data;
                setStats({
                    stories: {
                        active_count: storiesActive.count ?? 0,
                        needs_review: 0, // Column may not exist yet
                        enrichment_failed: storiesEnrichFailed.count ?? 0,
                        created_today: storiesToday.count ?? 0
                    },
                    articles: {
                        total_count: articlesTotal.count ?? 0,
                        today_count: articlesToday.count ?? 0
                    },
                    feeds: {
                        total: feeds.length,
                        active: feedsActive,
                        failed: feedsFailed
                    },
                    pardons: {
                        total: pardons.length,
                        published: pardons.filter(p => p.is_public).length,
                        draft: pardonsDraft,
                        needs_review: pardonsNeedsReview
                    },
                    scotus: {
                        total: scotus.length,
                        published: scotus.filter(s => s.is_public).length,
                        draft: scotusDraft
                    },
                    executive_orders: {
                        total: eosTotal.count ?? 0
                    },
                    budget: budget ? {
                        day: budget.day,
                        spent_usd: budget.spent_usd,
                        cap_usd: budget.cap_usd,
                        openai_calls: budget.openai_calls,
                        percent_used: budget.cap_usd > 0 ? Math.round((budget.spent_usd / budget.cap_usd) * 100) : 0
                    } : {
                        day: today,
                        spent_usd: 0,
                        cap_usd: 5.00,
                        openai_calls: 0,
                        percent_used: 0
                    },
                    pipeline: {
                        status: pipelineStatus,
                        message: pipelineMessage,
                        minutes_since_last_run: minutesSinceLastRun
                    },
                    needs_attention: {
                        total: (storiesEnrichFailed.count ?? 0) + pardonsDraft + scotusDraft + feedsFailed + pardonsNeedsReview,
                        breakdown: {
                            stories_need_review: 0,
                            stories_enrichment_failed: storiesEnrichFailed.count ?? 0,
                            pardons_need_review: pardonsNeedsReview,
                            pardons_unpublished: pardonsDraft,
                            scotus_unpublished: scotusDraft,
                            feeds_failed: feedsFailed
                        }
                    },
                    timestamp: now.toISOString()
                });
                setLastRefresh(now);
            };

            // Initial fetch and auto-refresh (only when authenticated)
            useEffect(() => {
                if (!isAuthenticated) return;

                fetchStats();

                // Auto-refresh every 5 minutes
                refreshIntervalRef.current = setInterval(fetchStats, 5 * 60 * 1000);

                return () => {
                    if (refreshIntervalRef.current) {
                        clearInterval(refreshIntervalRef.current);
                    }
                };
            }, [fetchStats, isAuthenticated]);

            // Format time since refresh
            const getTimeSinceRefresh = () => {
                if (!lastRefresh) return '';
                const seconds = Math.floor((new Date() - lastRefresh) / 1000);
                if (seconds < 60) return 'just now';
                const minutes = Math.floor(seconds / 60);
                return `${minutes}m ago`;
            };

            // Budget status
            const getBudgetStatus = () => {
                if (!stats?.budget) return { class: 'status-muted', label: 'N/A' };
                const pct = stats.budget.percent_used;
                if (pct >= 80) return { class: 'budget-danger', label: `$${stats.budget.spent_usd.toFixed(2)}/$${stats.budget.cap_usd}` };
                if (pct >= 50) return { class: 'budget-warning', label: `$${stats.budget.spent_usd.toFixed(2)}/$${stats.budget.cap_usd}` };
                return { class: 'budget-ok', label: `$${stats.budget.spent_usd.toFixed(2)}/$${stats.budget.cap_usd}` };
            };

            // Pipeline status
            const getPipelineStatus = () => {
                if (!stats?.pipeline) return { icon: '?', class: 'status-muted', label: 'Unknown' };
                const status = stats.pipeline.status;
                if (status === 'ok') return { icon: 'âœ“', class: 'status-ok', label: stats.pipeline.message };
                if (status === 'warning') return { icon: '!', class: 'status-warning', label: stats.pipeline.message };
                if (status === 'error') return { icon: 'âœ—', class: 'status-error', label: stats.pipeline.message };
                return { icon: '?', class: 'status-muted', label: stats.pipeline.message };
            };

            // Render tabs
            const tabs = [
                { id: 'home', label: 'Home' },
                { id: 'stories', label: 'Stories' },
                { id: 'pardons', label: 'Pardons', disabled: true },
                { id: 'scotus', label: 'SCOTUS', disabled: true },
                { id: 'eos', label: 'Exec Orders', disabled: true },
                { id: 'feeds', label: 'Feeds', disabled: true }
            ];

            const budgetStatus = getBudgetStatus();
            const pipelineStatus = getPipelineStatus();

            // Login screen
            if (!isAuthenticated) {
                return (
                    <div className="login-container">
                        <div className="login-card">
                            <h1>{env.label}</h1>
                            <p>Enter the admin password to continue</p>
                            {authError && <div className="login-error">{authError}</div>}
                            <form onSubmit={handleLogin}>
                                <input
                                    name="password"
                                    type="password"
                                    className="login-input"
                                    placeholder="Password"
                                    autoFocus
                                    disabled={authLoading}
                                />
                                <button type="submit" className="login-btn" disabled={authLoading || (lockoutUntil && Date.now() < lockoutUntil)}>
                                    {authLoading ? 'Signing in...' : 'Sign in'}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    {/* Header */}
                    <header className={`header ${env.isProd ? 'header-prod' : 'header-test'}`}>
                        <h1 className="header-title">{env.label}</h1>
                        <div className="header-right">
                            <div className="refresh-indicator">
                                <span>Updated {getTimeSinceRefresh()}</span>
                                <button
                                    onClick={() => { setLoading(true); fetchStats(); }}
                                    style={{ background: 'none', border: 'none', cursor: 'pointer', color: '#94a3b8', fontSize: '14px' }}
                                    disabled={loading}
                                >
                                    {loading ? '...' : 'â†»'}
                                </button>
                            </div>
                            <div className={`budget-indicator ${budgetStatus.class}`}>
                                <span>Budget:</span>
                                <span style={{ fontWeight: 600 }}>{budgetStatus.label}</span>
                            </div>
                            <button className="signout-btn" onClick={handleSignOut}>Sign out</button>
                        </div>
                    </header>

                    {/* Tab Navigation */}
                    <nav className="tab-nav">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                className={`tab-btn ${activeTab === tab.id ? 'active' : ''}`}
                                onClick={() => !tab.disabled && setActiveTab(tab.id)}
                                disabled={tab.disabled}
                                title={tab.disabled ? 'Coming soon' : ''}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </nav>

                    {/* Main Content */}
                    <main className="main-content">
                        {error && (
                            <div className="error-banner">
                                <strong>Error loading stats:</strong> {error}
                            </div>
                        )}

                        {loading && !stats ? (
                            <div className="loading">
                                <div className="spinner"></div>
                                Loading dashboard...
                            </div>
                        ) : activeTab === 'home' && stats && (
                            <div className="dashboard-grid">
                                {/* System Health */}
                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">
                                            <span>System Health</span>
                                        </h2>
                                    </div>
                                    <div className="card-body">
                                        <div className="status-row">
                                            <div className="status-label">
                                                <span className="status-icon">{pipelineStatus.icon === 'âœ“' ? 'ðŸŸ¢' : pipelineStatus.icon === '!' ? 'ðŸŸ¡' : pipelineStatus.icon === 'âœ—' ? 'ðŸ”´' : 'âšª'}</span>
                                                <span>RSS Pipeline</span>
                                            </div>
                                            <div className={`status-value ${pipelineStatus.class}`}>
                                                {pipelineStatus.label}
                                            </div>
                                        </div>
                                        <div className="status-row">
                                            <div className="status-label">
                                                <span className="status-icon">{stats.feeds.failed === 0 ? 'ðŸŸ¢' : stats.feeds.failed < 3 ? 'ðŸŸ¡' : 'ðŸ”´'}</span>
                                                <span>Active Feeds</span>
                                            </div>
                                            <div className={`status-value ${stats.feeds.failed === 0 ? 'status-ok' : stats.feeds.failed < 3 ? 'status-warning' : 'status-error'}`}>
                                                {stats.feeds.active}/{stats.feeds.total} active
                                            </div>
                                        </div>
                                        <div className="status-row">
                                            <div className="status-label">
                                                <span className="status-icon">{stats.budget.percent_used < 50 ? 'ðŸŸ¢' : stats.budget.percent_used < 80 ? 'ðŸŸ¡' : 'ðŸ”´'}</span>
                                                <span>Daily Budget</span>
                                            </div>
                                            <div className={`status-value ${stats.budget.percent_used < 50 ? 'status-ok' : stats.budget.percent_used < 80 ? 'status-warning' : 'status-error'}`}>
                                                {stats.budget.percent_used}% used
                                            </div>
                                        </div>
                                        <div className="status-row">
                                            <div className="status-label">
                                                <span className="status-icon">ðŸ“Š</span>
                                                <span>Active Stories</span>
                                            </div>
                                            <div className="status-value status-muted">
                                                {stats.stories.active_count.toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Needs Attention */}
                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">
                                            <span>Needs Attention</span>
                                            {stats.needs_attention.total > 0 && (
                                                <span className="attention-count">{stats.needs_attention.total}</span>
                                            )}
                                        </h2>
                                    </div>
                                    <div className="card-body">
                                        <div className="attention-item" title="Stories flagged for review">
                                            <span>Stories need review</span>
                                            <span className={`attention-count ${stats.needs_attention.breakdown.stories_need_review === 0 ? 'zero' : ''}`}>
                                                {stats.needs_attention.breakdown.stories_need_review}
                                            </span>
                                        </div>
                                        <div className="attention-item" title="Stories where AI enrichment failed">
                                            <span>Enrichment failures</span>
                                            <span className={`attention-count ${stats.needs_attention.breakdown.stories_enrichment_failed === 0 ? 'zero' : ''}`}>
                                                {stats.needs_attention.breakdown.stories_enrichment_failed}
                                            </span>
                                        </div>
                                        <div className="attention-item" title="Pardons not yet published">
                                            <span>Pardons unpublished</span>
                                            <span className={`attention-count ${stats.needs_attention.breakdown.pardons_unpublished === 0 ? 'zero' : ''}`}>
                                                {stats.needs_attention.breakdown.pardons_unpublished}
                                            </span>
                                        </div>
                                        <div className="attention-item" title="SCOTUS cases not yet published">
                                            <span>SCOTUS unpublished</span>
                                            <span className={`attention-count ${stats.needs_attention.breakdown.scotus_unpublished === 0 ? 'zero' : ''}`}>
                                                {stats.needs_attention.breakdown.scotus_unpublished}
                                            </span>
                                        </div>
                                        <div className="attention-item" title="Feeds with 5+ consecutive failures">
                                            <span>Feeds failed</span>
                                            <span className={`attention-count ${stats.needs_attention.breakdown.feeds_failed === 0 ? 'zero' : ''}`}>
                                                {stats.needs_attention.breakdown.feeds_failed}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                {/* Today's Activity */}
                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">Today's Activity</h2>
                                    </div>
                                    <div className="card-body">
                                        <div className="activity-stat">
                                            <div className="activity-icon articles">ðŸ“°</div>
                                            <div>
                                                <div className="activity-number">{stats.articles.today_count}</div>
                                                <div className="activity-label">articles ingested</div>
                                            </div>
                                        </div>
                                        <div className="activity-stat">
                                            <div className="activity-icon stories">ðŸ“–</div>
                                            <div>
                                                <div className="activity-number">{stats.stories.created_today}</div>
                                                <div className="activity-label">stories created</div>
                                            </div>
                                        </div>
                                        <div className="activity-stat">
                                            <div className="activity-icon enriched">ðŸ¤–</div>
                                            <div>
                                                <div className="activity-number">{stats.budget.openai_calls || 0}</div>
                                                <div className="activity-label">OpenAI calls</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Quick Actions */}
                                <div className="card">
                                    <div className="card-header">
                                        <h2 className="card-title">Quick Actions</h2>
                                    </div>
                                    <div className="card-body">
                                        <div className="quick-actions">
                                            <button
                                                className="action-btn"
                                                onClick={() => window.open('https://github.com/AJWolfe18/TTracker/actions/workflows/rss-tracker-test.yml', '_blank')}
                                            >
                                                ðŸ”„ Trigger Pipeline
                                            </button>
                                            <button
                                                className="action-btn"
                                                onClick={() => alert('Manual article submission coming in Phase 2')}
                                                disabled
                                            >
                                                ðŸ“° Submit Article
                                            </button>
                                            <button
                                                className="action-btn"
                                                onClick={() => window.open(`${window.SUPABASE_URL.replace('.supabase.co', '.supabase.co/project/default')}/editor`, '_blank')}
                                            >
                                                ðŸ—„ï¸ Open Supabase
                                            </button>
                                            <button
                                                className="action-btn"
                                                onClick={() => window.open('https://dev.azure.com/AJWolfe92/TTracker/_backlogs/backlog/TTracker%20Team/Backlog%20items', '_blank')}
                                            >
                                                ðŸ“‹ Open ADO
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Content Overview */}
                                <div className="card" style={{ gridColumn: 'span 2' }}>
                                    <div className="card-header">
                                        <h2 className="card-title">Content Overview</h2>
                                    </div>
                                    <div className="card-body">
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '24px' }}>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '32px', fontWeight: '600', color: '#3b82f6' }}>{stats.stories.active_count.toLocaleString()}</div>
                                                <div style={{ color: '#94a3b8', fontSize: '13px' }}>Active Stories</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '32px', fontWeight: '600', color: '#10b981' }}>{stats.articles.total_count.toLocaleString()}</div>
                                                <div style={{ color: '#94a3b8', fontSize: '13px' }}>Total Articles</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '32px', fontWeight: '600', color: '#f59e0b' }}>{stats.pardons.total}</div>
                                                <div style={{ color: '#94a3b8', fontSize: '13px' }}>Pardons ({stats.pardons.published} public)</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '32px', fontWeight: '600', color: '#8b5cf6' }}>{stats.scotus.total}</div>
                                                <div style={{ color: '#94a3b8', fontSize: '13px' }}>SCOTUS Cases ({stats.scotus.published} public)</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '32px', fontWeight: '600', color: '#ec4899' }}>{stats.executive_orders.total}</div>
                                                <div style={{ color: '#94a3b8', fontSize: '13px' }}>Executive Orders</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '32px', fontWeight: '600', color: '#06b6d4' }}>{stats.feeds.total}</div>
                                                <div style={{ color: '#94a3b8', fontSize: '13px' }}>RSS Feeds ({stats.feeds.active} active)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'stories' && (
                            <StoriesTab password={password} supabase={supabase} />
                        )}

                        {activeTab !== 'home' && activeTab !== 'stories' && (
                            <div className="card">
                                <div className="card-body" style={{ textAlign: 'center', padding: '60px 20px' }}>
                                    <div style={{ fontSize: '48px', marginBottom: '16px' }}>ðŸš§</div>
                                    <h2 style={{ margin: '0 0 8px', color: '#f8fafc' }}>Coming Soon</h2>
                                    <p style={{ color: '#94a3b8', margin: 0 }}>
                                        The {tabs.find(t => t.id === activeTab)?.label} tab is under development.
                                    </p>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<AdminDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
