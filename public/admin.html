<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrumpyTracker Admin</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            color: white; 
            min-height: 100vh; 
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { 
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            padding: 24px; 
            margin-bottom: 20px; 
            border: 1px solid rgba(71, 85, 105, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .input { 
            width: 100%; 
            padding: 12px 16px; 
            background: rgba(15, 23, 42, 0.8); 
            border: 1px solid rgba(71, 85, 105, 0.5); 
            border-radius: 8px; 
            color: white; 
            font-size: 14px; 
            transition: all 0.2s ease;
        }
        .input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); 
            color: white; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-success { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            color: white; 
        }
        .btn-success:hover:not(:disabled) { transform: translateY(-1px); }
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
        }
        .btn-danger:hover:not(:disabled) { transform: translateY(-1px); }
        .btn-secondary { 
            background: rgba(71, 85, 105, 0.8); 
            color: white; 
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        .btn-secondary:hover:not(:disabled) { 
            background: rgba(71, 85, 105, 1); 
            transform: translateY(-1px);
        }
        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; 
        }
        .btn-warning:hover:not(:disabled) { transform: translateY(-1px); }
        
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-4 { gap: 16px; }
        .gap-2 { gap: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 14px; }
        .text-xs { font-size: 12px; }
        .font-bold { font-weight: 700; }
        .grid { display: grid; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        
        .entry { 
            background: rgba(30, 41, 59, 0.6); 
            border: 1px solid rgba(71, 85, 105, 0.3); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .entry:hover { 
            background: rgba(30, 41, 59, 0.8); 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .entry.selected { 
            border-color: #3b82f6; 
            background: rgba(59, 130, 246, 0.1); 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .entry.editing { 
            border-color: #10b981; 
            background: rgba(16, 185, 129, 0.1); 
            cursor: default; 
        }
        .entry.new-entry {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
            animation: newEntryGlow 3s ease-out;
        }
        
        .queue-item {
            background: rgba(30, 41, 59, 0.6); 
            border: 1px solid rgba(71, 85, 105, 0.3); 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        .queue-item:hover { 
            background: rgba(30, 41, 59, 0.8); 
            transform: translateY(-1px);
        }
        .queue-item.pending { border-left: 4px solid #f59e0b; }
        .queue-item.failed { border-left: 4px solid #ef4444; }
        
        @keyframes newEntryGlow {
            0% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.6); }
            100% { box-shadow: 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .badge { 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: 600; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-high { 
            background: rgba(239, 68, 68, 0.2); 
            color: #fca5a5; 
            border: 1px solid rgba(239, 68, 68, 0.3); 
        }
        .badge-medium { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d; 
            border: 1px solid rgba(245, 158, 11, 0.3); 
        }
        .badge-low { 
            background: rgba(16, 185, 129, 0.2); 
            color: #6ee7b7; 
            border: 1px solid rgba(16, 185, 129, 0.3); 
        }
        .badge-archived { 
            background: rgba(139, 92, 246, 0.2); 
            color: #c4b5fd; 
            border: 1px solid rgba(139, 92, 246, 0.3); 
        }
        .badge-pending { 
            background: rgba(245, 158, 11, 0.2); 
            color: #fcd34d; 
            border: 1px solid rgba(245, 158, 11, 0.3); 
        }
        .badge-failed { 
            background: rgba(239, 68, 68, 0.2); 
            color: #fca5a5; 
            border: 1px solid rgba(239, 68, 68, 0.3); 
        }
        
        .logo { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #ef4444 0%, #3b82f6 100%); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 16px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .message { 
            padding: 12px 16px; 
            border-radius: 8px; 
            margin-bottom: 16px; 
            border-left: 4px solid;
            backdrop-filter: blur(10px);
        }
        .message-success { 
            background: rgba(16, 185, 129, 0.1); 
            color: #6ee7b7; 
            border-left-color: #10b981; 
        }
        .message-error { 
            background: rgba(239, 68, 68, 0.1); 
            color: #fca5a5; 
            border-left-color: #ef4444; 
        }
        .message-info { 
            background: rgba(59, 130, 246, 0.1); 
            color: #93c5fd; 
            border-left-color: #3b82f6; 
        }
        
        .scrollable { 
            height: calc(100vh - 420px); 
            overflow-y: auto; 
            padding-right: 8px;
        }
        .scrollable::-webkit-scrollbar { width: 6px; }
        .scrollable::-webkit-scrollbar-track { background: rgba(71, 85, 105, 0.2); border-radius: 3px; }
        .scrollable::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.5); border-radius: 3px; }
        .scrollable::-webkit-scrollbar-thumb:hover { background: rgba(71, 85, 105, 0.7); }
        
        .queue-scrollable {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(71, 85, 105, 0.3);
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .tab:hover {
            background: rgba(71, 85, 105, 0.2);
        }
        .tab.active {
            border-bottom-color: #3b82f6;
            color: #60a5fa;
        }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .flex-mobile { flex-direction: column; }
            .container { padding: 16px; }
            .scrollable { height: calc(100vh - 480px); }
        }
        
        select, textarea { 
            width: 100%; 
            padding: 12px 16px; 
            background: rgba(15, 23, 42, 0.8); 
            border: 1px solid rgba(71, 85, 105, 0.5); 
            border-radius: 8px; 
            color: white; 
            font-size: 14px; 
            font-family: inherit;
        }
        select:focus, textarea:focus { 
            outline: none; 
            border-color: #3b82f6; 
            background: rgba(15, 23, 42, 0.95);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        function AdminApp() {
            // === ALL STATE DECLARATIONS ===
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [token, setToken] = useState('');
            const [entries, setEntries] = useState([]);
            const [selectedEntries, setSelectedEntries] = useState(new Set());
            const [searchTerm, setSearchTerm] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [showArchived, setShowArchived] = useState(false);
            const [editingEntry, setEditingEntry] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [submissionUrl, setSubmissionUrl] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [newEntryId, setNewEntryId] = useState(null);
            
            // === NEW QUEUE MANAGEMENT STATE ===
            const [activeTab, setActiveTab] = useState('entries');
            const [pendingSubmissions, setPendingSubmissions] = useState([]);
            const [failedSubmissions, setFailedSubmissions] = useState([]);
            const [queueLoading, setQueueLoading] = useState(false);

            // === UTILITY FUNCTIONS ===
            const generateId = useCallback(() => {
                return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }, []);

            const encodeBase64 = useCallback((str) => {
                try {
                    return btoa(unescape(encodeURIComponent(str)));
                } catch {
                    return btoa(str);
                }
            }, []);

            const showMessage = useCallback((text, type = 'info') => {
                setMessage({ text, type });
                setTimeout(() => setMessage(null), 5000);
            }, []);

            // === AUTHENTICATION ===
            const authenticate = useCallback(() => {
                if (!token.trim()) {
                    showMessage('Please enter your GitHub token', 'error');
                    return;
                }
                if (!token.startsWith('github_pat_') && !token.startsWith('ghp_')) {
                    showMessage('Token must start with github_pat_ or ghp_', 'error');
                    return;
                }
                setIsAuthenticated(true);
                sessionStorage.setItem('admin_token', token);
                loadEntries();
                loadQueueData();
                showMessage('✅ Login successful', 'success');
            }, [token]);

            const logout = useCallback(() => {
                setIsAuthenticated(false);
                setToken('');
                sessionStorage.removeItem('admin_token');
                setEntries([]);
                setSelectedEntries(new Set());
                setPendingSubmissions([]);
                setFailedSubmissions([]);
                setMessage(null);
            }, []);

            // === DATA OPERATIONS ===
            const loadEntries = useCallback(async () => {
                try {
                    setIsLoading(true);
                    const response = await fetch('/master-tracker-log.json');
                    if (!response.ok) throw new Error('Failed to load entries');
                    const data = await response.json();
                    setEntries(Array.isArray(data) ? data : []);
                    showMessage(`📊 Loaded ${data?.length || 0} entries`, 'success');
                } catch (error) {
                    showMessage(`❌ Error: ${error.message}`, 'error');
                    setEntries([]);
                } finally {
                    setIsLoading(false);
                }
            }, [showMessage]);

            // === NEW QUEUE MANAGEMENT FUNCTIONS ===
            const loadQueueData = useCallback(async () => {
                try {
                    setQueueLoading(true);
                    
                    // Load pending submissions
                    try {
                        const pendingResponse = await fetch('/pending-submissions.json');
                        if (pendingResponse.ok) {
                            const pendingData = await pendingResponse.json();
                            setPendingSubmissions(Array.isArray(pendingData) ? pendingData : []);
                        } else {
                            setPendingSubmissions([]);
                        }
                    } catch {
                        setPendingSubmissions([]);
                    }
                    
                    // Load failed submissions
                    try {
                        const failedResponse = await fetch('/failed-submissions.json');
                        if (failedResponse.ok) {
                            const failedData = await failedResponse.json();
                            setFailedSubmissions(Array.isArray(failedData) ? failedData : []);
                        } else {
                            setFailedSubmissions([]);
                        }
                    } catch {
                        setFailedSubmissions([]);
                    }
                    
                } catch (error) {
                    showMessage(`❌ Error loading queue: ${error.message}`, 'error');
                } finally {
                    setQueueLoading(false);
                }
            }, [showMessage]);

            const updateGitHubFile = useCallback(async (newData, fileName = 'master-tracker-log.json') => {
                const repo = 'AJWolfe18/TTracker';
                const path = fileName;
                
                try {
                    // Get current file
                    let fileInfo = null;
                    try {
                        const getResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=main`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (getResponse.ok) {
                            fileInfo = await getResponse.json();
                        }
                    } catch (error) {
                        console.log(`File ${fileName} doesn't exist yet, will create new`);
                    }
                    
                    // Update file
                    const updateResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Admin update ${fileName}`,
                            content: encodeBase64(JSON.stringify(newData, null, 2)),
                            sha: fileInfo?.sha
                        })
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error(`Update failed: ${updateResponse.status}`);
                    }
                    
                    // Update public file for master tracker
                    if (fileName === 'master-tracker-log.json') {
                        try {
                            const publicGetResponse = await fetch(`https://api.github.com/repos/${repo}/contents/public/${path}?ref=main`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (publicGetResponse.ok) {
                                const publicFileInfo = await publicGetResponse.json();
                                await fetch(`https://api.github.com/repos/${repo}/contents/public/${path}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        message: `Admin update public ${fileName}`,
                                        content: encodeBase64(JSON.stringify(newData, null, 2)),
                                        sha: publicFileInfo.sha
                                    })
                                });
                            }
                        } catch (publicError) {
                            console.warn('Could not update public file:', publicError);
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.error('GitHub update error:', error);
                    throw error;
                }
            }, [token, encodeBase64]);

            // === QUEUE MANAGEMENT OPERATIONS ===
            const deleteSubmission = useCallback(async (submissionId, type) => {
                try {
                    setQueueLoading(true);
                    
                    if (type === 'pending') {
                        const updated = pendingSubmissions.filter(sub => sub.id !== submissionId);
                        await updateGitHubFile(updated, 'pending-submissions.json');
                        setPendingSubmissions(updated);
                    } else {
                        const updated = failedSubmissions.filter(sub => sub.id !== submissionId);
                        await updateGitHubFile(updated, 'failed-submissions.json');
                        setFailedSubmissions(updated);
                    }
                    
                    showMessage(`🗑️ Removed submission from ${type} queue`, 'success');
                } catch (error) {
                    showMessage(`❌ Delete failed: ${error.message}`, 'error');
                } finally {
                    setQueueLoading(false);
                }
            }, [pendingSubmissions, failedSubmissions, updateGitHubFile, showMessage]);

            const clearQueue = useCallback(async (type) => {
                if (!confirm(`Clear all ${type} submissions? This cannot be undone.`)) return;
                
                try {
                    setQueueLoading(true);
                    const fileName = type === 'pending' ? 'pending-submissions.json' : 'failed-submissions.json';
                    
                    await updateGitHubFile([], fileName);
                    
                    if (type === 'pending') {
                        setPendingSubmissions([]);
                    } else {
                        setFailedSubmissions([]);
                    }
                    
                    showMessage(`🧹 Cleared all ${type} submissions`, 'success');
                } catch (error) {
                    showMessage(`❌ Clear failed: ${error.message}`, 'error');
                } finally {
                    setQueueLoading(false);
                }
            }, [updateGitHubFile, showMessage]);

            const formatDate = useCallback((dateString) => {
                try {
                    return new Date(dateString).toLocaleString();
                } catch {
                    return 'Invalid Date';
                }
            }, []);

            const formatUrl = useCallback((url) => {
                try {
                    const urlObj = new URL(url);
                    return urlObj.hostname + urlObj.pathname;
                } catch {
                    return url;
                }
            }, []);

            // === MANUAL ARTICLE SUBMISSION ===
            const submitManualArticle = useCallback(async () => {
                if (!submissionUrl.trim()) return;
                
                try {
                    setIsSubmitting(true);
                    
                    // Validate URL
                    try {
                        new URL(submissionUrl);
                    } catch {
                        throw new Error('Please enter a valid URL');
                    }
                    
                    // Check for duplicates
                    const duplicates = entries.filter(entry => entry.source_url === submissionUrl);
                    if (duplicates.length > 0) {
                        const override = confirm(`⚠️ Duplicate found: "${duplicates[0].title}"\n\nSubmit anyway?`);
                        if (!override) {
                            setIsSubmitting(false);
                            return;
                        }
                    }
                    
                    showMessage('📝 Adding to processing queue...', 'info');
                    
                    // Create submission
                    const submission = {
                        url: submissionUrl,
                        submitted_by: 'admin',
                        submitted_at: new Date().toISOString(),
                        id: generateId()
                    };
                    
                    // Add to pending submissions
                    const updatedPending = [...pendingSubmissions, submission];
                    await updateGitHubFile(updatedPending, 'pending-submissions.json');
                    setPendingSubmissions(updatedPending);
                    
                    // Trigger workflow
                    await fetch(`https://api.github.com/repos/AJWolfe18/TTracker/dispatches`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            event_type: 'process-manual-submissions',
                            client_payload: {
                                submission_count: updatedPending.length,
                                latest_url: submissionUrl
                            }
                        })
                    });
                    
                    setSubmissionUrl('');
                    showMessage('✅ Article submitted for processing!', 'success');
                    
                    // Switch to queue tab to see the submission
                    setActiveTab('queue');
                    
                    // Refresh queue after 30 seconds
                    setTimeout(() => loadQueueData(), 30000);
                    
                } catch (error) {
                    showMessage(`❌ Submission failed: ${error.message}`, 'error');
                } finally {
                    setIsSubmitting(false);
                }
            }, [submissionUrl, entries, generateId, pendingSubmissions, updateGitHubFile, token, showMessage, loadQueueData]);

            // === ENTRY MANAGEMENT (existing functions - shortened for space) ===
            const archiveSelected = useCallback(async () => {
                if (selectedEntries.size === 0) return;
                if (!confirm(`Archive ${selectedEntries.size} entries?`)) return;
                
                try {
                    setIsLoading(true);
                    const updated = entries.map(entry => 
                        selectedEntries.has(entry.id) 
                            ? { ...entry, archived: true, archived_at: new Date().toISOString() }
                            : entry
                    );
                    await updateGitHubFile(updated);
                    setEntries(updated);
                    setSelectedEntries(new Set());
                    showMessage(`🗃️ Archived ${selectedEntries.size} entries`, 'success');
                } catch (error) {
                    showMessage(`❌ Archive failed: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            }, [selectedEntries, entries, updateGitHubFile, showMessage]);

            const restoreSelected = useCallback(async () => {
                if (selectedEntries.size === 0) return;
                
                try {
                    setIsLoading(true);
                    const updated = entries.map(entry => {
                        if (selectedEntries.has(entry.id)) {
                            const { archived, archived_at, ...restored } = entry;
                            return restored;
                        }
                        return entry;
                    });
                    await updateGitHubFile(updated);
                    setEntries(updated);
                    setSelectedEntries(new Set());
                    showMessage(`🔄 Restored ${selectedEntries.size} entries`, 'success');
                } catch (error) {
                    showMessage(`❌ Restore failed: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            }, [selectedEntries, entries, updateGitHubFile, showMessage]);

            const deleteSelected = useCallback(async () => {
                if (selectedEntries.size === 0) return;
                if (!confirm(`PERMANENTLY delete ${selectedEntries.size} entries?`)) return;
                
                try {
                    setIsLoading(true);
                    const updated = entries.filter(entry => !selectedEntries.has(entry.id));
                    await updateGitHubFile(updated);
                    setEntries(updated);
                    setSelectedEntries(new Set());
                    showMessage(`🗑️ Deleted ${selectedEntries.size} entries`, 'success');
                } catch (error) {
                    showMessage(`❌ Delete failed: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            }, [selectedEntries, entries, updateGitHubFile, showMessage]);

            // === EDITING (shortened) ===
            const startEdit = useCallback((entry) => {
                setEditingEntry(entry.id);
                setEditForm({
                    title: entry.title || '',
                    description: entry.description || '',
                    actor: entry.actor || '',
                    category: entry.category || 'Government Oversight',
                    severity: entry.severity || 'medium',
                    source_url: entry.source_url || '',
                    verified: Boolean(entry.verified),
                    date: entry.date || new Date().toISOString().split('T')[0]
                });
            }, []);

            const saveEdit = useCallback(async () => {
                try {
                    setIsLoading(true);
                    const updated = entries.map(entry => 
                        entry.id === editingEntry 
                            ? { ...entry, ...editForm, modified_at: new Date().toISOString() }
                            : entry
                    );
                    await updateGitHubFile(updated);
                    setEntries(updated);
                    setEditingEntry(null);
                    setEditForm({});
                    showMessage('✅ Entry updated', 'success');
                } catch (error) {
                    showMessage(`❌ Save failed: ${error.message}`, 'error');
                } finally {
                    setIsLoading(false);
                }
            }, [editingEntry, editForm, entries, updateGitHubFile, showMessage]);

            const cancelEdit = useCallback(() => {
                setEditingEntry(null);
                setEditForm({});
            }, []);

            // === SELECTION ===
            const toggleSelection = useCallback((entryId) => {
                const newSelected = new Set(selectedEntries);
                if (newSelected.has(entryId)) {
                    newSelected.delete(entryId);
                } else {
                    newSelected.add(entryId);
                }
                setSelectedEntries(newSelected);
            }, [selectedEntries]);

            const selectAll = useCallback(() => {
                const filtered = getFilteredEntries();
                if (selectedEntries.size === filtered.length) {
                    setSelectedEntries(new Set());
                } else {
                    setSelectedEntries(new Set(filtered.map(e => e.id)));
                }
            }, [selectedEntries]);

            // === FILTERING ===
            const getFilteredEntries = useCallback(() => {
                return entries.filter(entry => {
                    if (showArchived && !entry.archived) return false;
                    if (!showArchived && entry.archived) return false;
                    if (!searchTerm) return true;
                    
                    const searchLower = searchTerm.toLowerCase();
                    return Object.values(entry).some(val => 
                        val?.toString().toLowerCase().includes(searchLower)
                    );
                });
            }, [entries, showArchived, searchTerm]);

            // === EFFECTS ===
            useEffect(() => {
                const savedToken = sessionStorage.getItem('admin_token');
                if (savedToken) setToken(savedToken);
            }, []);

            useEffect(() => {
                if (newEntryId) {
                    const timer = setTimeout(() => setNewEntryId(null), 5000);
                    return () => clearTimeout(timer);
                }
            }, [newEntryId]);

            // === COMPUTED VALUES ===
            const filteredEntries = getFilteredEntries();

            // === RENDER ===
            if (!isAuthenticated) {
                return (
                    <div className="container">
                        <div style={{ maxWidth: '400px', margin: '100px auto' }}>
                            <div className="card text-center">
                                <div className="logo" style={{ margin: '0 auto 20px' }}>T2</div>
                                <h1 style={{ margin: '0 0 20px', background: 'linear-gradient(135deg, #60a5fa 0%, #ef4444 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                                    TrumpyTracker Admin
                                </h1>
                                
                                <div style={{ marginBottom: '16px' }}>
                                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px' }}>
                                        🔐 GitHub Token:
                                    </label>
                                    <input
                                        type="password"
                                        value={token}
                                        onChange={(e) => setToken(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && authenticate()}
                                        className="input"
                                        placeholder="github_pat_... or ghp_..."
                                        autoFocus
                                    />
                                </div>
                                
                                <button onClick={authenticate} className="btn btn-primary" style={{ width: '100%' }}>
                                    🚀 Login
                                </button>
                                
                                {message && (
                                    <div className={`message message-${message.type}`}>
                                        {message.text}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    {/* Header */}
                    <div className="card">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-4">
                                <div className="logo">T2</div>
                                <div>
                                    <h1 style={{ margin: 0, background: 'linear-gradient(135deg, #60a5fa 0%, #ef4444 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                                        Admin Panel
                                    </h1>
                                    <div style={{ fontSize: '14px', color: '#94a3b8' }}>Political Tracker Management</div>
                                </div>
                            </div>
                            <button onClick={logout} className="btn btn-danger">
                                🚪 Logout
                            </button>
                        </div>
                        
                        {/* Manual Article Submission */}
                        <div className="flex gap-4 mb-4 flex-mobile">
                            <input
                                type="url"
                                value={submissionUrl}
                                onChange={(e) => setSubmissionUrl(e.target.value)}
                                placeholder="📎 Paste article URL to submit manually..."
                                className="input"
                                style={{ flex: 1 }}
                                disabled={isSubmitting}
                            />
                            <button 
                                onClick={submitManualArticle} 
                                disabled={!submissionUrl.trim() || isSubmitting || isLoading} 
                                className="btn btn-success"
                            >
                                {isSubmitting ? '🔄 Processing...' : '📰 Submit Article'}
                            </button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="card">
                        <div className="tabs">
                            <div 
                                className={`tab ${activeTab === 'entries' ? 'active' : ''}`}
                                onClick={() => setActiveTab('entries')}
                            >
                                📋 Entries ({filteredEntries.length})
                            </div>
                            <div 
                                className={`tab ${activeTab === 'queue' ? 'active' : ''}`}
                                onClick={() => {
                                    setActiveTab('queue');
                                    loadQueueData();
                                }}
                            >
                                ⏳ Submission Queue ({pendingSubmissions.length + failedSubmissions.length})
                            </div>
                        </div>

                        {/* Messages */}
                        {message && (
                            <div className={`message message-${message.type}`}>
                                {message.text}
                            </div>
                        )}

                        {/* Tab Content */}
                        {activeTab === 'entries' ? (
                            <>
                                {/* Entry Management Controls */}
                                <div className="flex gap-4 mb-4 flex-mobile">
                                    <input
                                        type="text"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        placeholder="🔍 Search entries..."
                                        className="input"
                                        style={{ flex: 1 }}
                                    />
                                    <button onClick={loadEntries} disabled={isLoading} className="btn btn-primary">
                                        {isLoading ? '🔄' : '📊'} Refresh
                                    </button>
                                </div>
                                
                                <div className="flex gap-2 mb-4 flex-mobile">
                                    <span className="text-sm" style={{ color: '#94a3b8' }}>
                                        📋 {filteredEntries.length} entries ({selectedEntries.size} selected)
                                    </span>
                                    <button
                                        onClick={() => setShowArchived(!showArchived)}
                                        className="btn btn-secondary"
                                    >
                                        {showArchived ? '📂 Active' : '🗃️ Archives'}
                                    </button>
                                    <button onClick={selectAll} className="btn btn-secondary">
                                        {selectedEntries.size === filteredEntries.length ? '❌ None' : '✅ All'}
                                    </button>
                                    {!showArchived ? (
                                        <button onClick={archiveSelected} disabled={selectedEntries.size === 0 || isLoading} className="btn btn-secondary">
                                            🗃️ Archive ({selectedEntries.size})
                                        </button>
                                    ) : (
                                        <button onClick={restoreSelected} disabled={selectedEntries.size === 0 || isLoading} className="btn btn-success">
                                            🔄 Restore ({selectedEntries.size})
                                        </button>
                                    )}
                                    <button onClick={deleteSelected} disabled={selectedEntries.size === 0 || isLoading} className="btn btn-danger">
                                        🗑️ Delete ({selectedEntries.size})
                                    </button>
                                </div>

                                {/* Entries List */}
                                <div className="scrollable">
                                    {filteredEntries.length === 0 ? (
                                        <div className="text-center" style={{ padding: '40px' }}>
                                            <div style={{ fontSize: '48px', marginBottom: '16px' }}>📊</div>
                                            <div style={{ color: '#94a3b8' }}>No entries found</div>
                                        </div>
                                    ) : (
                                        filteredEntries.map(entry => (
                                            <div
                                                key={entry.id}
                                                className={`entry ${selectedEntries.has(entry.id) ? 'selected' : ''} ${editingEntry === entry.id ? 'editing' : ''} ${newEntryId === entry.id ? 'new-entry' : ''}`}
                                                onClick={() => editingEntry !== entry.id && toggleSelection(entry.id)}
                                            >
                                                {editingEntry === entry.id ? (
                                                    <div>
                                                        <div className="grid grid-2 gap-4 mb-4">
                                                            <div>
                                                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Date</label>
                                                                <input
                                                                    type="date"
                                                                    value={editForm.date}
                                                                    onChange={(e) => setEditForm({...editForm, date: e.target.value})}
                                                                    className="input"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Severity</label>
                                                                <select
                                                                    value={editForm.severity}
                                                                    onChange={(e) => setEditForm({...editForm, severity: e.target.value})}
                                                                    className="input"
                                                                >
                                                                    <option value="low">🟢 Low</option>
                                                                    <option value="medium">🟡 Medium</option>
                                                                    <option value="high">🔴 High</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="mb-4">
                                                            <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Actor</label>
                                                            <input
                                                                type="text"
                                                                value={editForm.actor}
                                                                onChange={(e) => setEditForm({...editForm, actor: e.target.value})}
                                                                className="input"
                                                            />
                                                        </div>
                                                        
                                                        <div className="mb-4">
                                                            <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Title</label>
                                                            <input
                                                                type="text"
                                                                value={editForm.title}
                                                                onChange={(e) => setEditForm({...editForm, title: e.target.value})}
                                                                className="input"
                                                            />
                                                        </div>
                                                        
                                                        <div className="mb-4">
                                                            <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Description</label>
                                                            <textarea
                                                                value={editForm.description}
                                                                onChange={(e) => setEditForm({...editForm, description: e.target.value})}
                                                                className="input"
                                                                rows="3"
                                                            />
                                                        </div>
                                                        
                                                        <div className="grid grid-2 gap-4 mb-4">
                                                            <div>
                                                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Category</label>
                                                                <select
                                                                    value={editForm.category}
                                                                    onChange={(e) => setEditForm({...editForm, category: e.target.value})}
                                                                    className="input"
                                                                >
                                                                    <option value="Financial">Financial</option>
                                                                    <option value="Civil Liberties">Civil Liberties</option>
                                                                    <option value="Platform Manipulation">Platform Manipulation</option>
                                                                    <option value="Government Oversight">Government Oversight</option>
                                                                    <option value="Election Integrity">Election Integrity</option>
                                                                    <option value="Corporate Ethics">Corporate Ethics</option>
                                                                    <option value="Legal Proceedings">Legal Proceedings</option>
                                                                </select>
                                                            </div>
                                                            <div>
                                                                <label style={{ display: 'block', marginBottom: '4px', fontSize: '12px', color: '#94a3b8' }}>Source URL</label>
                                                                <input
                                                                    type="url"
                                                                    value={editForm.source_url}
                                                                    onChange={(e) => setEditForm({...editForm, source_url: e.target.value})}
                                                                    className="input"
                                                                />
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="mb-4">
                                                            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={editForm.verified}
                                                                    onChange={(e) => setEditForm({...editForm, verified: e.target.checked})}
                                                                />
                                                                <span style={{ fontSize: '14px' }}>✅ Verified Source</span>
                                                            </label>
                                                        </div>
                                                        
                                                        <div className="flex gap-2">
                                                            <button onClick={saveEdit} disabled={isLoading} className="btn btn-success">
                                                                💾 Save
                                                            </button>
                                                            <button onClick={cancelEdit} className="btn btn-secondary">
                                                                ❌ Cancel
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="flex justify-between">
                                                        <div style={{ flex: 1 }}>
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <span className="text-sm" style={{ color: '#94a3b8' }}>📅 {entry.date}</span>
                                                                <span className={`badge badge-${entry.severity}`}>
                                                                    {entry.severity === 'high' ? '🚨 HIGH' :
                                                                     entry.severity === 'medium' ? '⚠️ MED' : '🟢 LOW'}
                                                                </span>
                                                                {entry.archived && <span className="badge badge-archived">🗃️ Archived</span>}
                                                                <span className="text-sm" style={{ color: '#60a5fa' }}>{entry.actor}</span>
                                                                {entry.manual_submission && <span className="text-xs" style={{ color: '#10b981' }}>📝 Manual</span>}
                                                            </div>
                                                            <h3 style={{ margin: '0 0 8px', fontWeight: 600 }}>{entry.title}</h3>
                                                            <p style={{ margin: '0 0 8px', fontSize: '14px', color: '#d1d5db' }}>{entry.description}</p>
                                                            <div className="flex items-center gap-4 text-xs" style={{ color: '#94a3b8' }}>
                                                                <span>📁 {entry.category}</span>
                                                                {entry.verified && <span style={{ color: '#10b981' }}>✅ Verified</span>}
                                                                {entry.source_url && (
                                                                    <a 
                                                                        href={entry.source_url} 
                                                                        target="_blank" 
                                                                        rel="noopener noreferrer"
                                                                        style={{ color: '#60a5fa', textDecoration: 'none' }}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                    >
                                                                        🔗 Source
                                                                    </a>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-start gap-2" style={{ marginLeft: '16px' }}>
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); startEdit(entry); }}
                                                                className="btn btn-primary"
                                                                style={{ padding: '6px 12px', fontSize: '12px' }}
                                                            >
                                                                ✏️ Edit
                                                            </button>
                                                            <input
                                                                type="checkbox"
                                                                checked={selectedEntries.has(entry.id)}
                                                                onChange={(e) => { e.stopPropagation(); toggleSelection(entry.id); }}
                                                                style={{ marginTop: '4px' }}
                                                            />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))
                                    )}
                                </div>
                            </>
                        ) : (
                            // Queue Management Tab
                            <>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 style={{ margin: 0, fontSize: '18px', fontWeight: 600 }}>
                                        📦 Submission Queue Manager
                                    </h2>
                                    <button 
                                        onClick={loadQueueData} 
                                        disabled={queueLoading} 
                                        className="btn btn-primary"
                                    >
                                        {queueLoading ? '🔄' : '📊'} Refresh Queue
                                    </button>
                                </div>

                                {/* Queue Statistics */}
                                <div className="grid grid-2 gap-4 mb-4">
                                    <div className="card" style={{ margin: 0, padding: '16px' }}>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h3 style={{ margin: 0, fontSize: '14px', color: '#fcd34d' }}>⏳ Pending</h3>
                                                <p style={{ margin: '4px 0 0', fontSize: '24px', fontWeight: 'bold' }}>{pendingSubmissions.length}</p>
                                                <p style={{ margin: 0, fontSize: '12px', color: '#94a3b8' }}>Awaiting processing</p>
                                            </div>
                                            <button 
                                                onClick={() => clearQueue('pending')} 
                                                disabled={pendingSubmissions.length === 0 || queueLoading}
                                                className="btn btn-warning"
                                                style={{ padding: '6px 12px', fontSize: '12px' }}
                                            >
                                                🧹 Clear All
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div className="card" style={{ margin: 0, padding: '16px' }}>
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h3 style={{ margin: 0, fontSize: '14px', color: '#fca5a5' }}>❌ Failed</h3>
                                                <p style={{ margin: '4px 0 0', fontSize: '24px', fontWeight: 'bold' }}>{failedSubmissions.length}</p>
                                                <p style={{ margin: 0, fontSize: '12px', color: '#94a3b8' }}>Processing errors</p>
                                            </div>
                                            <button 
                                                onClick={() => clearQueue('failed')} 
                                                disabled={failedSubmissions.length === 0 || queueLoading}
                                                className="btn btn-danger"
                                                style={{ padding: '6px 12px', fontSize: '12px' }}
                                            >
                                                🧹 Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Pending Submissions */}
                                {pendingSubmissions.length > 0 && (
                                    <div style={{ marginBottom: '24px' }}>
                                        <h3 style={{ margin: '0 0 12px', fontSize: '16px', color: '#fcd34d' }}>⏳ Pending Submissions</h3>
                                        <div className="queue-scrollable">
                                            {pendingSubmissions.map(submission => (
                                                <div key={submission.id} className="queue-item pending">
                                                    <div className="flex justify-between items-start">
                                                        <div style={{ flex: 1 }}>
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <span className="badge badge-pending">PENDING</span>
                                                                <span className="text-xs" style={{ color: '#94a3b8' }}>
                                                                    Submitted: {formatDate(submission.submitted_at)}
                                                                </span>
                                                            </div>
                                                            <p style={{ margin: '0 0 8px', fontWeight: 500 }}>{formatUrl(submission.url)}</p>
                                                            <a 
                                                                href={submission.url} 
                                                                target="_blank" 
                                                                rel="noopener noreferrer"
                                                                className="text-xs" 
                                                                style={{ color: '#60a5fa', textDecoration: 'none' }}
                                                            >
                                                                🔗 View Article
                                                            </a>
                                                        </div>
                                                        <button 
                                                            onClick={() => deleteSubmission(submission.id, 'pending')}
                                                            disabled={queueLoading}
                                                            className="btn btn-danger"
                                                            style={{ padding: '6px 12px', fontSize: '12px' }}
                                                        >
                                                            🗑️ Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Failed Submissions */}
                                {failedSubmissions.length > 0 && (
                                    <div>
                                        <h3 style={{ margin: '0 0 12px', fontSize: '16px', color: '#fca5a5' }}>❌ Failed Submissions</h3>
                                        <div className="queue-scrollable">
                                            {failedSubmissions.map(submission => (
                                                <div key={submission.id} className="queue-item failed">
                                                    <div className="flex justify-between items-start">
                                                        <div style={{ flex: 1 }}>
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <span className="badge badge-failed">FAILED</span>
                                                                <span className="text-xs" style={{ color: '#94a3b8' }}>
                                                                    Failed: {formatDate(submission.failed_at)}
                                                                </span>
                                                            </div>
                                                            <p style={{ margin: '0 0 8px', fontWeight: 500 }}>{formatUrl(submission.url)}</p>
                                                            {submission.error && (
                                                                <p style={{ margin: '0 0 8px', fontSize: '12px', color: '#fca5a5' }}>
                                                                    Error: {submission.error}
                                                                </p>
                                                            )}
                                                            <a 
                                                                href={submission.url} 
                                                                target="_blank" 
                                                                rel="noopener noreferrer"
                                                                className="text-xs" 
                                                                style={{ color: '#60a5fa', textDecoration: 'none' }}
                                                            >
                                                                🔗 View Article
                                                            </a>
                                                        </div>
                                                        <button 
                                                            onClick={() => deleteSubmission(submission.id, 'failed')}
                                                            disabled={queueLoading}
                                                            className="btn btn-danger"
                                                            style={{ padding: '6px 12px', fontSize: '12px' }}
                                                        >
                                                            🗑️ Remove
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Empty State */}
                                {pendingSubmissions.length === 0 && failedSubmissions.length === 0 && (
                                    <div className="text-center" style={{ padding: '40px' }}>
                                        <div style={{ fontSize: '48px', marginBottom: '16px' }}>📭</div>
                                        <div style={{ color: '#94a3b8', fontSize: '18px', marginBottom: '8px' }}>Queue is Empty</div>
                                        <div style={{ color: '#6b7280', fontSize: '14px' }}>No pending or failed submissions</div>
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<AdminApp />, document.getElementById('root'));
    </script>
</body>
</html>
