<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard Test Suite</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            background: #1a202c;
            color: white;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #2d3748;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test-result.pass {
            background: rgba(56, 161, 105, 0.2);
            border: 1px solid #38a169;
        }
        .test-result.fail {
            background: rgba(229, 62, 62, 0.2);
            border: 1px solid #e53e3e;
        }
        .test-result.pending {
            background: rgba(237, 137, 54, 0.2);
            border: 1px solid #ed8936;
        }
        .status {
            font-weight: bold;
        }
        button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #2c5aa0;
        }
        .summary {
            background: #4a5568;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
    <script src="supabase-browser-config.js"></script>
</head>
<body>
    <h1>ðŸ§ª Admin Dashboard Test Suite</h1>
    
    <div class="test-section">
        <h2>Configuration Tests</h2>
        <div id="config-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>Functionality Tests</h2>
        <div id="function-tests"></div>
        <button onclick="runFunctionalTests()">Run Functional Tests</button>
    </div>
    
    <div class="test-section">
        <h2>Performance Tests</h2>
        <div id="performance-tests"></div>
        <button onclick="runPerformanceTests()">Run Performance Tests</button>
    </div>
    
    <div id="summary" class="summary" style="display: none;">
        <h3>Test Summary</h3>
        <p>Passed: <span id="passed">0</span></p>
        <p>Failed: <span id="failed">0</span></p>
        <p>Total: <span id="total">0</span></p>
    </div>
    
    <div class="test-section">
        <h2>Live Admin Panel (for manual testing)</h2>
        <iframe src="admin-supabase.html" id="admin-frame"></iframe>
    </div>
    
    <script>
        let testResults = {
            passed: 0,
            failed: 0,
            total: 0
        };
        
        function updateTestResult(testId, status, message) {
            const element = document.getElementById(testId);
            if (element) {
                element.className = `test-result ${status}`;
                element.querySelector('.status').textContent = status.toUpperCase();
                if (message) {
                    element.querySelector('.message').textContent = message;
                }
                
                // Update counts
                if (status === 'pass') testResults.passed++;
                else if (status === 'fail') testResults.failed++;
                testResults.total++;
                updateSummary();
            }
        }
        
        function updateSummary() {
            document.getElementById('summary').style.display = 'block';
            document.getElementById('passed').textContent = testResults.passed;
            document.getElementById('failed').textContent = testResults.failed;
            document.getElementById('total').textContent = testResults.total;
        }
        
        // Configuration Tests (run immediately)
        function runConfigTests() {
            const configTests = document.getElementById('config-tests');
            
            // Test 1: Supabase config loaded
            configTests.innerHTML += `
                <div id="test-config-loaded" class="test-result pending">
                    <span>Supabase configuration loaded</span>
                    <span class="status">PENDING</span>
                    <span class="message"></span>
                </div>
            `;
            
            if (window.SUPABASE_CONFIG) {
                updateTestResult('test-config-loaded', 'pass', 'Config loaded successfully');
            } else {
                updateTestResult('test-config-loaded', 'fail', 'Config not found');
            }
            
            // Test 2: Correct environment detection
            configTests.innerHTML += `
                <div id="test-env-detection" class="test-result pending">
                    <span>Environment detection</span>
                    <span class="status">PENDING</span>
                    <span class="message"></span>
                </div>
            `;
            
            const isTest = window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.SUPABASE_URL.includes('wnrjrywpcadwutfykflu');
            const expectedTest = window.location.hostname.includes('test--') || window.location.hostname === 'localhost';
            
            if ((isTest && expectedTest) || (!isTest && !expectedTest)) {
                updateTestResult('test-env-detection', 'pass', `Correctly detected: ${isTest ? 'TEST' : 'PRODUCTION'}`);
            } else {
                updateTestResult('test-env-detection', 'fail', `Mismatch: detected ${isTest ? 'TEST' : 'PROD'} but URL suggests ${expectedTest ? 'TEST' : 'PROD'}`);
            }
            
            // Test 3: API Keys present
            configTests.innerHTML += `
                <div id="test-api-keys" class="test-result pending">
                    <span>API keys configured</span>
                    <span class="status">PENDING</span>
                    <span class="message"></span>
                </div>
            `;
            
            if (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.SUPABASE_URL && window.SUPABASE_CONFIG.SUPABASE_ANON_KEY) {
                updateTestResult('test-api-keys', 'pass', 'Both URL and key present');
            } else {
                updateTestResult('test-api-keys', 'fail', 'Missing configuration');
            }
        }
        
        // Functional Tests
        async function runFunctionalTests() {
            const funcTests = document.getElementById('function-tests');
            funcTests.innerHTML = '';
            
            // Test 1: Can connect to Supabase
            funcTests.innerHTML += `
                <div id="test-supabase-connection" class="test-result pending">
                    <span>Supabase connection</span>
                    <span class="status">TESTING...</span>
                    <span class="message"></span>
                </div>
            `;
            
            try {
                const response = await fetch(`${window.SUPABASE_CONFIG.SUPABASE_URL}/rest/v1/`, {
                    method: 'HEAD',
                    headers: {
                        'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY
                    }
                });
                
                if (response.ok || response.status === 406) {
                    updateTestResult('test-supabase-connection', 'pass', 'Connected successfully');
                } else {
                    updateTestResult('test-supabase-connection', 'fail', `Status: ${response.status}`);
                }
            } catch (error) {
                updateTestResult('test-supabase-connection', 'fail', error.message);
            }
            
            // Test 2: Can fetch entries
            funcTests.innerHTML += `
                <div id="test-fetch-entries" class="test-result pending">
                    <span>Fetch entries from database</span>
                    <span class="status">TESTING...</span>
                    <span class="message"></span>
                </div>
            `;
            
            try {
                const response = await fetch(
                    `${window.SUPABASE_CONFIG.SUPABASE_URL}/rest/v1/political_entries?limit=1`,
                    {
                        headers: {
                            'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    updateTestResult('test-fetch-entries', 'pass', `Found ${data.length} entries`);
                } else {
                    updateTestResult('test-fetch-entries', 'fail', `Status: ${response.status}`);
                }
            } catch (error) {
                updateTestResult('test-fetch-entries', 'fail', error.message);
            }
            
            // Test 3: Archive operation (PATCH)
            funcTests.innerHTML += `
                <div id="test-archive-operation" class="test-result pending">
                    <span>Archive operation (PATCH request)</span>
                    <span class="status">TESTING...</span>
                    <span class="message"></span>
                </div>
            `;
            
            try {
                // First get an entry to test with
                const getResponse = await fetch(
                    `${window.SUPABASE_CONFIG.SUPABASE_URL}/rest/v1/political_entries?limit=1`,
                    {
                        headers: {
                            'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                if (getResponse.ok) {
                    const entries = await getResponse.json();
                    if (entries.length > 0) {
                        const testId = entries[0].id;
                        const currentArchived = entries[0].archived;
                        
                        // Try to toggle archived status
                        const patchResponse = await fetch(
                            `${window.SUPABASE_CONFIG.SUPABASE_URL}/rest/v1/political_entries?id=eq.${testId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${window.SUPABASE_CONFIG.SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify({ archived: !currentArchived })
                            }
                        );
                        
                        if (patchResponse.ok) {
                            // Toggle it back
                            await fetch(
                                `${window.SUPABASE_CONFIG.SUPABASE_URL}/rest/v1/political_entries?id=eq.${testId}`,
                                {
                                    method: 'PATCH',
                                    headers: {
                                        'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${window.SUPABASE_CONFIG.SUPABASE_ANON_KEY}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ archived: currentArchived })
                                }
                            );
                            updateTestResult('test-archive-operation', 'pass', 'Archive toggle successful');
                        } else {
                            const error = await patchResponse.text();
                            updateTestResult('test-archive-operation', 'fail', `PATCH failed: ${error}`);
                        }
                    } else {
                        updateTestResult('test-archive-operation', 'fail', 'No entries to test with');
                    }
                } else {
                    updateTestResult('test-archive-operation', 'fail', 'Could not fetch test entry');
                }
            } catch (error) {
                updateTestResult('test-archive-operation', 'fail', error.message);
            }
        }
        
        // Performance Tests
        async function runPerformanceTests() {
            const perfTests = document.getElementById('performance-tests');
            perfTests.innerHTML = '';
            
            // Test 1: Load time for 50 entries
            perfTests.innerHTML += `
                <div id="test-load-time" class="test-result pending">
                    <span>Load time for 50 entries</span>
                    <span class="status">TESTING...</span>
                    <span class="message"></span>
                </div>
            `;
            
            try {
                const startTime = performance.now();
                const response = await fetch(
                    `${window.SUPABASE_CONFIG.SUPABASE_URL}/rest/v1/political_entries?limit=50&order=date.desc`,
                    {
                        headers: {
                            'apikey': window.SUPABASE_CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${window.SUPABASE_CONFIG.SUPABASE_ANON_KEY}`
                        }
                    }
                );
                
                if (response.ok) {
                    await response.json();
                    const endTime = performance.now();
                    const loadTime = Math.round(endTime - startTime);
                    
                    if (loadTime < 1000) {
                        updateTestResult('test-load-time', 'pass', `${loadTime}ms (< 1 second)`);
                    } else {
                        updateTestResult('test-load-time', 'fail', `${loadTime}ms (> 1 second)`);
                    }
                } else {
                    updateTestResult('test-load-time', 'fail', 'Could not load entries');
                }
            } catch (error) {
                updateTestResult('test-load-time', 'fail', error.message);
            }
            
            // Test 2: Cache functionality
            perfTests.innerHTML += `
                <div id="test-cache" class="test-result pending">
                    <span>Cache functionality</span>
                    <span class="status">TESTING...</span>
                    <span class="message"></span>
                </div>
            `;
            
            try {
                // Save test data to cache
                const testData = [{ id: 1, test: true }];
                localStorage.setItem('admin_entries_cache', JSON.stringify({
                    data: testData,
                    timestamp: Date.now(),
                    environment: 'test'
                }));
                
                // Try to read it back
                const cached = localStorage.getItem('admin_entries_cache');
                if (cached) {
                    const parsed = JSON.parse(cached);
                    if (parsed.data && parsed.data[0].test === true) {
                        updateTestResult('test-cache', 'pass', 'Cache read/write working');
                    } else {
                        updateTestResult('test-cache', 'fail', 'Cache data corrupted');
                    }
                } else {
                    updateTestResult('test-cache', 'fail', 'Could not read cache');
                }
                
                // Clean up
                localStorage.removeItem('admin_entries_cache');
            } catch (error) {
                updateTestResult('test-cache', 'fail', error.message);
            }
        }
        
        // Run config tests on load
        runConfigTests();
    </script>
</body>
</html>
