<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Environment Health Check</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .check-item {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .check-item.success {
            border-color: #0f0;
            background: #001100;
        }
        .check-item.error {
            border-color: #f00;
            background: #110000;
        }
        .check-item.warning {
            border-color: #ff0;
            background: #111100;
        }
        h1 {
            text-align: center;
            border-bottom: 2px solid #0f0;
            padding-bottom: 10px;
        }
        .status {
            font-weight: bold;
            float: right;
        }
        .success .status { color: #0f0; }
        .error .status { color: #f00; }
        .warning .status { color: #ff0; }
        .details {
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }
        button {
            background: #00a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00c;
        }
        .summary {
            background: #111;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .summary.all-good {
            border: 2px solid #0f0;
        }
        .summary.has-issues {
            border: 2px solid #f00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Environment Health Check</h1>
        
        <div class="summary" id="summary">
            <h2>Running checks...</h2>
        </div>
        
        <div id="checks">
            <div class="check-item" id="env-check">
                <span class="status">‚è≥</span>
                <strong>Environment Detection</strong>
                <div class="details">Checking if test environment is properly detected...</div>
            </div>
            
            <div class="check-item" id="db-check">
                <span class="status">‚è≥</span>
                <strong>Database Connection</strong>
                <div class="details">Testing connection to test database...</div>
            </div>
            
            <div class="check-item" id="schema-check">
                <span class="status">‚è≥</span>
                <strong>Schema Validation</strong>
                <div class="details">Checking for required columns and views...</div>
            </div>
            
            <div class="check-item" id="data-check">
                <span class="status">‚è≥</span>
                <strong>Data Integrity</strong>
                <div class="details">Verifying data counts and structure...</div>
            </div>
            
            <div class="check-item" id="view-check">
                <span class="status">‚è≥</span>
                <strong>Dashboard Stats View</strong>
                <div class="details">Testing dashboard_stats view...</div>
            </div>
            
            <div class="check-item" id="cache-check">
                <span class="status">‚è≥</span>
                <strong>Cache Status</strong>
                <div class="details">Checking browser cache...</div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="runAllChecks()">üîÑ Re-run All Checks</button>
            <button onclick="clearCacheAndRerun()">üóëÔ∏è Clear Cache & Re-run</button>
            <button onclick="window.location.href='/'">üìä Go to Dashboard</button>
        </div>
    </div>

    <script src="supabase-browser-config.js"></script>
    <script>
        const checks = {
            env: false,
            db: false,
            schema: false,
            data: false,
            view: false,
            cache: false
        };
        
        async function checkEnvironment() {
            const checkDiv = document.getElementById('env-check');
            const url = window.SUPABASE_URL || window.SUPABASE_CONFIG?.SUPABASE_URL;
            const isTest = url && url.includes('wnrjrywpcadwutfykflu');
            
            if (isTest) {
                checkDiv.className = 'check-item success';
                checkDiv.querySelector('.status').textContent = '‚úÖ';
                checkDiv.querySelector('.details').innerHTML = `
                    Using TEST database: ${url.substring(8, 28)}...
                    <br>Test badge should be visible on dashboard
                `;
                checks.env = true;
            } else {
                checkDiv.className = 'check-item error';
                checkDiv.querySelector('.status').textContent = '‚ùå';
                checkDiv.querySelector('.details').innerHTML = `
                    Wrong database! Using: ${url ? url.substring(8, 28) : 'UNKNOWN'}...
                    <br>Expected: wnrjrywpcadwutfykflu
                `;
            }
        }
        
        async function checkDatabase() {
            const checkDiv = document.getElementById('db-check');
            const url = window.SUPABASE_URL || window.SUPABASE_CONFIG?.SUPABASE_URL;
            const key = window.SUPABASE_ANON_KEY || window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
            
            try {
                const response = await fetch(`${url}/rest/v1/political_entries?select=count`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Prefer': 'count=exact',
                        'Range': '0-0'
                    }
                });
                
                if (response.ok) {
                    checkDiv.className = 'check-item success';
                    checkDiv.querySelector('.status').textContent = '‚úÖ';
                    checkDiv.querySelector('.details').textContent = 'Database connection successful';
                    checks.db = true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                checkDiv.className = 'check-item error';
                checkDiv.querySelector('.status').textContent = '‚ùå';
                checkDiv.querySelector('.details').textContent = `Connection failed: ${error.message}`;
            }
        }
        
        async function checkSchema() {
            const checkDiv = document.getElementById('schema-check');
            const url = window.SUPABASE_URL || window.SUPABASE_CONFIG?.SUPABASE_URL;
            const key = window.SUPABASE_ANON_KEY || window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
            
            try {
                // Try to query with added_at column
                const response = await fetch(`${url}/rest/v1/political_entries?select=id,added_at&limit=1`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });
                
                if (response.ok) {
                    checkDiv.className = 'check-item success';
                    checkDiv.querySelector('.status').textContent = '‚úÖ';
                    checkDiv.querySelector('.details').textContent = 'Schema has required columns (including added_at)';
                    checks.schema = true;
                } else if (response.status === 400) {
                    const error = await response.json();
                    if (error.message && error.message.includes('added_at')) {
                        checkDiv.className = 'check-item warning';
                        checkDiv.querySelector('.status').textContent = '‚ö†Ô∏è';
                        checkDiv.querySelector('.details').innerHTML = `
                            Missing 'added_at' column - run this SQL in test DB:
                            <br>ALTER TABLE political_entries ADD COLUMN added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
                        `;
                    } else {
                        throw new Error('Schema validation failed');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                checkDiv.className = 'check-item error';
                checkDiv.querySelector('.status').textContent = '‚ùå';
                checkDiv.querySelector('.details').textContent = `Schema check failed: ${error.message}`;
            }
        }
        
        async function checkData() {
            const checkDiv = document.getElementById('data-check');
            const url = window.SUPABASE_URL || window.SUPABASE_CONFIG?.SUPABASE_URL;
            const key = window.SUPABASE_ANON_KEY || window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
            
            try {
                const politicalResponse = await fetch(`${url}/rest/v1/political_entries?select=*`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Prefer': 'count=exact',
                        'Range': '0-0'
                    }
                });
                
                const eoResponse = await fetch(`${url}/rest/v1/executive_orders?select=*`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`,
                        'Prefer': 'count=exact',
                        'Range': '0-0'
                    }
                });
                
                const politicalCount = politicalResponse.headers.get('content-range')?.split('/')[1] || '0';
                const eoCount = eoResponse.headers.get('content-range')?.split('/')[1] || '0';
                
                checkDiv.className = 'check-item success';
                checkDiv.querySelector('.status').textContent = '‚úÖ';
                checkDiv.querySelector('.details').innerHTML = `
                    Political Entries: ${politicalCount}<br>
                    Executive Orders: ${eoCount}<br>
                    ${parseInt(politicalCount) > 100 ? '‚úÖ Data replicated from production' : '‚ö†Ô∏è Consider replicating production data'}
                `;
                checks.data = true;
            } catch (error) {
                checkDiv.className = 'check-item error';
                checkDiv.querySelector('.status').textContent = '‚ùå';
                checkDiv.querySelector('.details').textContent = `Data check failed: ${error.message}`;
            }
        }
        
        async function checkView() {
            const checkDiv = document.getElementById('view-check');
            const url = window.SUPABASE_URL || window.SUPABASE_CONFIG?.SUPABASE_URL;
            const key = window.SUPABASE_ANON_KEY || window.SUPABASE_CONFIG?.SUPABASE_ANON_KEY;
            
            try {
                const response = await fetch(`${url}/rest/v1/dashboard_stats`, {
                    headers: {
                        'apikey': key,
                        'Authorization': `Bearer ${key}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    checkDiv.className = 'check-item success';
                    checkDiv.querySelector('.status').textContent = '‚úÖ';
                    checkDiv.querySelector('.details').innerHTML = `
                        View working - Stats returned:<br>
                        Total: ${data[0]?.total_entries || 0}, 
                        High: ${data[0]?.high_severity_count || 0}, 
                        EOs: ${data[0]?.total_executive_orders || 0}
                    `;
                    checks.view = true;
                } else if (response.status === 404) {
                    checkDiv.className = 'check-item error';
                    checkDiv.querySelector('.status').textContent = '‚ùå';
                    checkDiv.querySelector('.details').innerHTML = `
                        dashboard_stats view missing!<br>
                        Run the SQL from fix-dashboard-stats-view.sql in test DB
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                checkDiv.className = 'check-item error';
                checkDiv.querySelector('.status').textContent = '‚ùå';
                checkDiv.querySelector('.details').textContent = `View check failed: ${error.message}`;
            }
        }
        
        async function checkCache() {
            const checkDiv = document.getElementById('cache-check');
            const cacheKeys = Object.keys(localStorage).filter(k => k.startsWith('tt_cache_'));
            
            if (cacheKeys.length > 0) {
                checkDiv.className = 'check-item warning';
                checkDiv.querySelector('.status').textContent = '‚ö†Ô∏è';
                checkDiv.querySelector('.details').innerHTML = `
                    ${cacheKeys.length} cached items found<br>
                    Consider clearing cache if seeing old data
                `;
            } else {
                checkDiv.className = 'check-item success';
                checkDiv.querySelector('.status').textContent = '‚úÖ';
                checkDiv.querySelector('.details').textContent = 'No cached data (fresh state)';
                checks.cache = true;
            }
        }
        
        async function runAllChecks() {
            await checkEnvironment();
            await checkDatabase();
            await checkSchema();
            await checkData();
            await checkView();
            await checkCache();
            
            // Update summary
            const allGood = Object.values(checks).every(v => v);
            const summary = document.getElementById('summary');
            
            if (allGood) {
                summary.className = 'summary all-good';
                summary.innerHTML = `
                    <h2>‚úÖ All Systems Operational!</h2>
                    <p>Your test environment is fully configured and working correctly.</p>
                `;
            } else {
                const issues = Object.entries(checks).filter(([k, v]) => !v).map(([k]) => k);
                summary.className = 'summary has-issues';
                summary.innerHTML = `
                    <h2>‚ö†Ô∏è Some Issues Detected</h2>
                    <p>Issues with: ${issues.join(', ')}</p>
                    <p>Review the checks above for details.</p>
                `;
            }
        }
        
        function clearCacheAndRerun() {
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('tt_cache_')) {
                    localStorage.removeItem(key);
                }
            });
            runAllChecks();
        }
        
        // Run checks on load
        window.addEventListener('DOMContentLoaded', runAllChecks);
    </script>
</body>
</html>